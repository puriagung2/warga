<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Warga - Puri Agung 2</title>
  <meta charset="UTF-8">
  <meta name="description" content="e-Warga RW6 adalah aplikasi digital untuk membantu pengelolaan data warga perumahan Puri Agung 2 RW 6 secara terpusat. Aplikasi ini memudahkan pengurus RW/RT dalam mencatat, memperbarui, serta memantau data warga secara cepat, rapi, dan transparan melalui perangkat mobile.">
  <meta name="keywords" content="HTML, CSS, JavaScript">
  <meta name="author" content="@masjokos">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/puriagung2/warga/refs/heads/main/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/puriagung2/warga/9cf89acc6d6b8eb775cb663b206ac7c2b9806231/favicon.svg" />
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/puriagung2/warga/refs/heads/main/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/puriagung2/warga/refs/heads/main/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="e-RW6" />
  <link rel="manifest" href="https://raw.githubusercontent.com/puriagung2/warga/refs/heads/main/site.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
:root {
  --soft-indigo: #6366f1;
  --bg-milk: #F8FAFC; 
  --pastel-bg: rgba(255,255,255,0.92);
  --pastel-primary: #8b8cf8;
  --pastel-active: #f163cd;
  --pastel-muted: #94a3b8;
  --border-color: #f1f5f9;
  --border-light: #f8fafc;
  
  /* Variabel tambahan untuk Input & Popup */
  --card-bg: #ffffff;
  --text-main: #334155;
  --input-text: #1e293b;
  --input-bg: #f1f5f9;
}

/* Tambahkan ini jika Anda menggunakan class .dark pada body/html */
.dark {
  --bg-milk: #0f172a; /* Slate 900 */
  --card-bg: #1e293b; /* Slate 800 */
  --text-main: #f1f5f9; /* Slate 100 */
  --input-text: #f8fafc;
  --input-bg: #334155; /* Slate 700 */
}

    /* Variabel Khusus Dark Mode */
    body.dark {
        border-color: var(--border-color) !important;
      --bg-milk: #0f172a; /* Slate 900 */
      --card-bg: #1e293b; /* Slate 800 */
      --text-main: #f1f5f9; /* Slate 100 */
      --text-muted: #94a3b8; /* Slate 400 */
      --border-color: #334155; 
      --input-bg: #0f172a;
    }

 /* Khusus untuk teks di dalam modal detail saat Dark Mode */
body.dark #detail-content h3, 
body.dark #detail-content p,
body.dark #detail-content span:not(.material-icons) {
    color: var(--text-main) !important;
}
body.dark .bg-slate-50, 
body.dark .bg-slate-100 {
    background-color: rgba(255, 255, 255, 0.05) !important; /* Background gelap transparan */
    color: var(--text-muted) !important; /* Teks abu-abu terang */
    border: 1px solid var(--border-color);
}
/* Label keterangan (NIK, No KK, dll) agar sedikit lebih redup tapi terbaca */
body.dark #detail-content .text-slate-500,
body.dark #detail-content .text-slate-400 {
    color: var(--text-muted) !important;
}

/* Card kecil di dalam detail (misal kotak NIK/No KK) */
body.dark #detail-content .bg-slate-50 {
    background-color: var(--input-bg) !important;
    border: 1px solid var(--border-color);
}

/* Ikon di dalam detail agar warnanya tetap bagus */
body.dark #detail-content .text-indigo-600,
body.dark #detail-content .text-indigo-500 {
    color: var(--pastel-primary) !important;
}   
body.dark h1, 
body.dark h2, 
body.dark h3, 
body.dark h4, 
body.dark p, 
body.dark span:not(.material-icons) {
    color: var(--text-main) !important;
}
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background-color: var(--bg-milk); 
      color: #334155;
      margin: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    #loading-overlay-lama {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center; justify-content: center;
    }

    /* Overlay Loading */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none; /* Sembunyikan secara default */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: white;
    font-family: sans-serif;
}

/* Animasi Spinner */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}
    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-weight: bold;
    letter-spacing: 1px;
}

    #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
    #main-app { display: none; flex-direction: column; justify-content: flex-start; gap: 0; }
    #user-info-banner {
    padding-top: 0 !important;
    padding-bottom: 10px !important;
    margin-top: -4px; /* Menarik sedikit ke atas agar lebih rapat */
}    
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .login-card { background: white; width: 100%; max-width: 400px; padding: 40px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.05); text-align: center; }
    
    .input-group { position: relative; margin-bottom: 12px; }
    .input-group .material-icons { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 18px; }
    .material-symbols-rounded {
    font-variation-settings:
    'FILL' 1,
    'wght' 500,
    'GRAD' 0,
    'opsz' 24;
     }

    .modern-input {
    width: 100%;
    padding: 12px 16px 12px 35px;
    background-color: var(--input-bg) !important; /* Gunakan variabel */
    border: 1.5px solid var(--border-color) !important; /* Gunakan variabel */
    border-radius: 16px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main) !important; /* Gunakan variabel */
    outline: none;
    transition: all 0.3s;
}

.modern-input:focus {
    border-color: var(--soft-indigo) !important;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.form-label {
    display: block;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
    padding-left: 4px;
}
    
    /* input.modern-input, select.modern-input, textarea.modern-input {width: 100%; background: #f8fafc; border: 2px solid #f1f5f9; padding: 12px 16px 12px 35px; border-radius: 16px; font-size: 13px; font-weight: 600; color: #1e293b;} */
    input.modern-input, select.modern-input, textarea.modern-input {
      background-color: var(--input-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-main) !important;
    }
    textarea.modern-input { padding-left: 16px; min-height: 80px; }

    .form-label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin: 0 0 6px 10px; }
    .btn-submit { width: 100%; background: #ff93ad; color: white; padding: 16px; border-radius: 20px; font-weight: 700; margin-top: 10px; }

    /* Dashboard UI */
    /* Update elemen agar mengikuti variabel */
   .stat-card, .warga-card, .login-card, #detail-modal { 
    background-color: var(--card-bg) !important; 
    border-color: var(--border-color) !important; 
    color: var(--text-main);
    /* Tambahkan/Pastikan baris ini ada: */
    border-radius: 20px !important; /* Sama dengan rounded-3xl di Tailwind */
    padding: 20px; 
    position: relative; 
    overflow: hidden; /* Menjaga isi chart tidak keluar dari lengkungan */
    transition: background-color 0.3s, border-color 0.3s;
}
    /* .stat-card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #f1f5f9; position: relative; overflow: hidden; } */
    .stat-card2 { background: #f2d7ee; padding: 20px; border-radius: 24px; border: 1px solid #f1f5f9; position: relative; overflow: hidden; }
    .stat-card3 { background: #b1e9e5; padding: 20px; border-radius: 24px; border: 1px solid #f1f5f9; position: relative; overflow: hidden; }

    /* Gabungan Bottom Nav yang Mendukung Dark Mode */
    .bottom-nav { 
      position: fixed; 
      bottom: 0px; 
      left: 0px; 
      right: 0px; 
      /* Menggunakan variabel agar otomatis berubah */
      background-color: var(--card-bg); 
      backdrop-filter: blur(10px); 
      height: 70px; 
      border-radius: 20px 20px 0 0; 
      display: flex; 
      align-items: center; 
      justify-content: space-around; 
      /* Shadow lebih halus di dark mode */
      box-shadow: 0 -6px 20px rgba(0,0,0,0.05); 
      z-index: 4000; 
      border-top: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* Memperbaiki warna teks item nav agar tidak hilang */
    .nav-item { 
      position: relative;
      color: var(--text-muted); 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      font-size: 9px; 
      font-weight: 800; 
      text-transform: uppercase; 
      border: none; 
      background: none; 
      outline: none;
      padding: 8px 12px;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Efek pegas */
      cursor: pointer;
    }
/* Efek Hover: Bergeser ke atas sedikit dan muncul background halus */
    .nav-item:hover {
      color: var(--soft-indigo);
      transform: translateY(-5px);
      background-color: rgba(99, 102, 241, 0.08); /* Indigo transparan */
    }

    /* Efek Klik (Active State) */
    .nav-item:active {
      color: var(--pastel-active) !important;
      transform: scale(0.9);
    }
    .nav-item.active::after {
      transform: translateX(-50%) scaleX(1); /* Garis muncul */
    }
    /* Indikator Garis di Atas (Hanya muncul saat .active) */
    .nav-item::after {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0); /* Sembunyi secara default */
      width: 20px;
      height: 4px;
      background: var(--pastel-active);
      border-radius: 0 0 4px 4px;
      transition: transform 0.3s ease;
    }
    /* Icon Animation pada Hover */
    .nav-item:hover .material-icons {
      transform: scale(1.1);
      filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.3));
    }
    /* Animasi Ikon saat Aktif */
    .nav-item.active .material-icons {
      transform: translateY(2px);
      filter: drop-shadow(0 4px 6px rgba(241, 99, 205, 0.4));
    }
  /* Penyesuaian Dark Mode Hover */
    body.dark .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--pastel-active);
    }

    /* Tambahkan sedikit cahaya (glow) pada background saat aktif di Dark Mode */
    body.dark .nav-item.active {
      background: radial-gradient(circle, rgba(241, 99, 205, 0.1) 0%, transparent 70%);
    }
    
    /* Memperbaiki tombol tambah tengah agar bordernya tidak putih mencolok di dark mode */
  .btn-add-center { 
      background: var(--pastel-primary); 
      color: white; 
      width: 58px; 
      height: 58px; 
      border-radius: 22px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transform: translateY(-22px); 
      box-shadow: 0 10px 18px rgba(99, 102, 241, 0.3); 
      border: 4px solid var(--card-bg); 
      cursor: pointer; 
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek membal */
    }

    .btn-add-center:hover {
      transform: translateY(-28px) scale(1.1) rotate(90deg); /* Berputar saat hover */
      box-shadow: 0 15px 25px rgba(99, 102, 241, 0.5);
      background: var(--soft-indigo);
    }

    .btn-add-center:active {
      transform: translateY(-22px) scale(0.9);
    }

    /* Penyesuaian shadow saat hover di mode dark */
    body.dark .btn-add-center {
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    
    .warga-card { background: white; padding: 12px; border-radius: 20px; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; border: 1px solid #f1f5f9; cursor: pointer; transition: transform 0.2s; }
    .warga-card:active { transform: scale(0.98); }
    .avatar { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; }

    .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; padding-bottom: 20px; }
    .btn-page { background: white; border: 1px solid #f1f5f9; padding: 8px 12px; border-radius: 12px; font-weight: 800; font-size: 10px; color: #64748b; text-transform: uppercase; }
    .btn-page:disabled { opacity: 0.3; }

    /* Gaya Tombol Tab untuk Statistik */
    .tab-btn { 
      padding: 12px 20px; 
      border-radius: 16px; 
      font-size: 11px; 
      font-weight: 800; 
      text-transform: uppercase; 
      background: white; 
      color: #94a3b8; 
      border: 1px solid #f1f5f9; 
      transition: all 0.2s;
      white-space: nowrap;
      cursor: pointer;
    }
    .tab-btn.active { 
      background: var(--soft-indigo); 
      color: white; 
      border-color: var(--soft-indigo); 
      box-shadow: 0 8px 15px rgba(99,102,241,0.2); 
    }
    
    #detail-modal { position: fixed; inset: 0; background: white; z-index: 3000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 110px; }
  
    .required-icon {
  color: #ef4444; /* Warna merah (Tailwind red-500) */
  margin-left: 2px;
  font-weight: bold;
}
    @keyframes popupScale {
    0% { transform: scale(0.7); opacity: 0; }
    50% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); }
}

.animate-popup {
    animation: popupScale 0.4s ease;
}
/* Animasi Getar untuk Input Error */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    50% { transform: translateX(8px); }
    75% { transform: translateX(-8px); }
}

.animate-shake {
    animation: shake 0.3s ease-in-out;
    border-color: #ef4444 !important; /* Merah tegas */
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
}

    /* Pastikan Modal Ulang Tahun Adaptif */
#modal-ultah .bg-white {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border-color);
}

/* Judul Modal */
#modal-ultah h3 {
    color: var(--text-main) !important;
}

/* Tombol Close */
#modal-ultah button .material-icons {
    color: var(--text-muted);
}

/* Perbaikan untuk tombol Aamiin (agar tetap pink tapi teks putih) */
#modal-ultah .bg-slate-800 {
    background-color: #f5adbe !important; /* Warna pink soft */
    color: white !important;
}
    body.dark #modal-ultah button[style*="background-color: #f5adbe"] {
    box-shadow: 0 4px 15px rgba(245, 173, 190, 0.3);
}
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
  </style>
</head>
<body>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="status-text">MENGOLAH GAMBAR...</div>
</div>
  
  <div id="loading-overlay-lama">
    <div class="flex flex-col items-center">
      <div class="w-10 h-10 border-4 border-indigo-100 border-t-indigo-500 rounded-full animate-spin"></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal">
    <div class="p-6">
        <div class="flex justify-between items-center mb-6">
            <button onclick="handleBackAction()" class="text-slate-400 border-none bg-none"><span class="material-icons">arrow_back_ios</span></button>
            <h2 class="text-lg font-black text-slate-800">Profil Lengkap</h2>
            <button id="btn-edit-trigger" class="text-indigo-500 font-bold text-sm bg-none border-none">Edit</button>
        </div>
        <div id="detail-content" class="space-y-4"></div>
    </div>
  </div>

  <div id="auth-container">
    <div class="login-card">
        <img src="https://raw.githubusercontent.com/masjokos/puriagung2/refs/heads/main/logopuriagung2.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 object-contain">
        <h1 class="text-xl font-extrabold text-slate-800 mb-8">E-Warga RW6</h1>
        <form onsubmit="handleLogin(event)">
            <div class="input-group"><input type="text" id="login-user" placeholder="Username" class="modern-input" required><span class="material-icons">person</span></div>
            <div class="input-group"><input type="password" id="login-pass" placeholder="Password" class="modern-input" required><span class="material-icons">lock</span></div>
            <button type="submit" class="btn-submit !mt-4">Masuk</button>
        </form>
    </div>
  </div>

  <div id="main-app">
    <header class="p-6 pb-2 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/masjokos/puriagung2/refs/heads/main/logopuriagung2.png" alt="Logo" class="w-10 h-10 object-contain">
          <div>
                <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Puri Agung 2</p>
                <h1 id="welcome-text" class="text-xl font-extrabold text-slate-800 leading-tight">E-WARGA RW6</h1>
         </div>
        </div>

        <div class="flex items-center gap-4">
            <button onclick="toggleDarkMode()" class="text-slate-300 hover:text-yellow-500 transition-colors">
                <span class="material-icons" id="dark-icon">dark_mode</span>
            </button>
            <button onclick="refreshData()" class="text-slate-300 hover:text-indigo-500 transition-colors">
                <span class="material-icons" id="refresh-icon">refresh</span>
            </button>
<!-- update profil -->
          <button onclick="openProfileModal()" class="text-slate-400 hover:text-indigo-600 transition-colors">
    <span class="material-icons">account_circle</span>
</button>

<div id="profile-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl animate__animated animate__zoomIn animate__faster">
        <div class="bg-indigo-600 p-8 text-center relative">
            <button onclick="closeProfileModal()" class="absolute right-4 top-4 text-white/50 hover:text-white">
                <span class="material-icons">close</span>
            </button>
            <div class="w-20 h-20 bg-white/20 rounded-full mx-auto flex items-center justify-center border-4 border-white/30 mb-3">
                <span class="material-icons text-white text-4xl">person</span>
            </div>
            <h3 id="prof-display-name" class="text-white font-black text-lg">Nama Pengguna</h3>
            <p id="prof-display-role" class="text-indigo-100 text-[10px] uppercase tracking-widest font-bold">Role</p>
        </div>

        <div class="p-6 space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nama Lengkap</label>
                <input type="text" id="prof-nama" class="w-full px-4 py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Username</label>
                <input type="text" id="prof-username" readonly class="w-full px-4 py-3 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border-none text-sm font-bold text-slate-400 cursor-not-allowed">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ganti Password (Isi jika ingin ubah)</label>
                <input type="password" id="prof-password" placeholder="••••••••" class="w-full px-4 py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-indigo-500">
            </div>

            <button onclick="updateProfile()" id="btn-save-profile" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-indigo-200 dark:shadow-none active:scale-95 transition-all flex items-center justify-center gap-2">
                <span class="material-icons text-sm">save</span> SIMPAN PERUBAHAN
            </button>

            <button onclick="logout()" class="w-full py-3 text-red-500 font-bold text-xs flex items-center justify-center gap-1 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all">
                <span class="material-icons text-sm">logout</span> KELUAR DARI APLIKASI
            </button>
        </div>
    </div>
</div>
        </div>
    </header>

    <div id="user-info-banner" class="px-7 py-1 mb-2 transition-all duration-300" style="display: none;">
        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 py-1.5 px-3 rounded-full w-fit border border-slate-100 dark:border-slate-700">
            <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
            <p class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 tracking-wide" id="user-display-text">
                Memuat informasi user...
            </p>
        </div>
    </div> 


    <main class="flex-1 p-6 pb-32">
      <!-- Dashboard -->
      <section id="page-dashboard" class="page active space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="stat-card2">
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Warga</p>
                <h2 id="stat-total" class="text-2xl font-black text-slate-800">0</h2>
            </div>
            <div class="stat-card3">
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Kepala Keluarga</p>
                <h2 id="stat-kk" class="text-2xl font-black text-slate-800">0</h2>
            </div>
        </div>
        
        <div class="stat-card">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-4">Statistik Jenis Kelamin</p>
            <div class="flex items-center gap-4">
                <div class="w-24 h-24"><canvas id="chartGender"></canvas></div>
                <div class="flex-1 space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-indigo-400"></div><span class="text-[10px] font-bold text-slate-500">Laki-laki</span></div>
                        <span id="label-pria" class="text-xs font-black text-slate-800">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-pink-400"></div><span class="text-[10px] font-bold text-slate-500">Perempuan</span></div>
                        <span id="label-wanita" class="text-xs font-black text-slate-800">0</span>
                    </div>
                </div>
            </div>
        </div>

<div class="stat-card">
    <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-4">Statistik Usia</p>
    <div class="flex items-center gap-4">
        <div class="w-24 h-24 relative"><canvas id="chartAge"></canvas></div>
        
        <div class="flex-1 space-y-1">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-cyan-400"></div><span class="text-[9px] font-bold text-slate-500">Balita (0-4)</span></div>
                <span id="label-balita" class="text-xs font-black text-slate-800">0</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-lime-400"></div><span class="text-[9px] font-bold text-slate-500">Anak (5-11)</span></div>
                <span id="label-anak" class="text-xs font-black text-slate-800">0</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div><span class="text-[9px] font-bold text-slate-500">Remaja (12-18)</span></div>
                <span id="label-remaja" class="text-xs font-black text-slate-800">0</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-600"></div><span class="text-[9px] font-bold text-slate-500">Dewasa (19-59)</span></div>
                <span id="label-dewasa" class="text-xs font-black text-slate-800">0</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-orange-500"></div><span class="text-[9px] font-bold text-slate-500">Lansia (60+)</span></div>
                <span id="label-lansia" class="text-xs font-black text-slate-800">0</span>
            </div>
        </div>
    </div>
</div>

        <div class="stat-card">
    <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-4">Statistik Status Tinggal</p>
    <div class="flex items-center gap-4">
        <div class="w-24 h-24"><canvas id="chartTinggal"></canvas></div>
        
        <div id="tinggal-legend" class="flex-1 space-y-2"> </div>
    </div>
    </div>

        <div class="stat-card">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-4">Distribusi Per RT</p>
            <div class="h-40">
                <canvas id="chartRT"></canvas>
            </div>
        </div>

        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest pt-4">Warga Terbaru</h3>
        <div id="latest-list"></div>
      </section>

<section id="page-stats" class="page space-y-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black text-slate-800">Demografi Warga</h2>
        <button onclick="openExportSheet()" class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center active:scale-90 transition-transform">
            <span class="material-icons">ios_share</span>
        </button>
    </div>
    
    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
        <button onclick="changeStatPage('balita')" id="tab-balita" class="tab-btn active flex items-center gap-1 whitespace-nowrap">
            Balita <span id="badge-balita" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
        <button onclick="changeStatPage('anak')" id="tab-anak" class="tab-btn flex items-center gap-1 whitespace-nowrap">
            Anak <span id="badge-anak" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
        <button onclick="changeStatPage('remaja')" id="tab-remaja" class="tab-btn flex items-center gap-1 whitespace-nowrap">
            Remaja <span id="badge-remaja" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
        <button onclick="changeStatPage('dewasa')" id="tab-dewasa" class="tab-btn flex items-center gap-1 whitespace-nowrap">
            Dewasa <span id="badge-dewasa" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
        <button onclick="changeStatPage('lansia')" id="tab-lansia" class="tab-btn flex items-center gap-1 whitespace-nowrap">
            Lansia <span id="badge-lansia" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
        <button onclick="changeStatPage('ultah')" id="tab-ultah" class="tab-btn flex items-center gap-1 whitespace-nowrap">
            Ultah <span id="badge-ultah" class="bg-indigo-600 text-white dark:bg-indigo-500 dark:text-white px-1.5 py-0.5 rounded-lg text-[8px] font-bold">0</span>
        </button>
    </div>

    <div id="stat-list-container" class="space-y-3"></div>

    <div id="stat-pagination" class="pagination-controls mt-4"></div>
</section>

<div id="export-sheet" class="fixed inset-0 z-[10000] hidden items-end sm:items-center justify-center p-0 sm:p-6">
    <div onclick="closeExportSheet()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>

    <div class="relative w-full max-w-lg bg-white dark:bg-slate-900 rounded-t-[40px] sm:rounded-[40px] p-8 shadow-2xl animate-in slide-in-from-bottom sm:zoom-in duration-300 border-t dark:border-slate-800">
        <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-8 sm:hidden"></div>
      
        <h3 class="text-xl font-black text-slate-800 dark:text-slate-100 mb-1">Ekspor Data Warga</h3>
        <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-8">Format: Excel & PDF</p>

        <div class="space-y-5">
            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase ml-2 tracking-widest">Wilayah</label>
                <select id="export-rt" class="w-full bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-slate-100 border-2 border-transparent focus:border-indigo-500 rounded-2xl text-xs font-bold p-4 outline-none transition-all">
                    <option value="ALL" class="bg-white dark:bg-slate-900">Semua RT (RW 06)</option>
                    <option value="1" class="bg-white dark:bg-slate-900">RT 1</option>
                    <option value="2" class="bg-white dark:bg-slate-900">RT 2</option>
                    <option value="3" class="bg-white dark:bg-slate-900">RT 3</option>
                    <option value="4" class="bg-white dark:bg-slate-900">RT 4</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase ml-2 tracking-widest">Status</label>
                    <select id="export-tinggal" class="w-full bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-slate-100 border-2 border-transparent focus:border-indigo-500 rounded-2xl text-xs font-bold p-4 outline-none transition-all">
                        <option value="ALL" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Semua</option>
                        <option value="TETAP" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Tetap</option>
                        <option value="KONTRAK" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Kontrak</option>
                        <option value="KOS" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Kos</option>

                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase ml-2 tracking-widest">Kategori</label>
                    <select id="export-kategori" class="w-full bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-slate-100 border-2 border-transparent focus:border-indigo-500 rounded-2xl text-xs font-bold p-4 outline-none transition-all">
                        <option value="ALL" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Semua</option>
                        <option value="BALITA" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Balita</option>
                        <option value="ANAK" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Anak</option>
                        <option value="REMAJA" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Remaja</option>
                        <option value="LANSIA" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">Lansia</option>
                        <option value="KEPALA KELUARGA" class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">KK Saja</option>

                    </select>
                </div>
            </div>

            <div class="flex gap-4 pt-6">
                <button onclick="prosesExport('xlsx')" class="flex-1 bg-emerald-500 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-500/20 active:scale-95 transition-all">Excel</button>
                <button onclick="prosesExport('pdf')" class="flex-1 bg-rose-500 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-rose-500/20 active:scale-95 transition-all">PDF</button>
            </div>
        </div>
    </div>
</div>
     
      <!-- Daftar Warga -->
      <section id="page-warga" class="page">
        <h2 class="text-xl font-black text-slate-800 mb-4">Daftar Warga</h2>
        <div class="mb-4 space-y-3">
            <div class="input-group">
                <input type="text" id="search-warga" placeholder="Cari Nama, NIK, Blok..." class="modern-input" oninput="resetWargaPage(); filterWargaList()">
                <span class="material-icons">search</span>
            </div>
            <div class="input-group !mb-0">
                <select id="filter-rt" class="modern-input !pl-10" onchange="resetWargaPage(); filterWargaList()">
                    <option value="">Semua RT</option>
                    <option value="1">RT 01</option><option value="2">RT 02</option><option value="3">RT 03</option><option value="4">RT 04</option>
                </select>
                <span class="material-icons">filter_list</span>
            </div>
        </div>
        <div id="all-warga-list"></div>
        <div id="warga-pagination" class="pagination-controls"></div>
      </section>

      <!-- Data Keluarga -->
<!-- Data Keluarga -->
<section id="page-kk" class="page">
  <h2 class="text-xl font-black text-slate-800 mb-4">Data Kepala Keluarga</h2>

  <div class="mb-4 space-y-3">
    <!-- Search -->
    <div class="input-group">
      <input type="text" id="search-kk"
             placeholder="Cari Nama KK atau No KK..."
             class="modern-input"
             oninput="resetKkPage(); filterKkList()">
      <span class="material-icons">search</span>
    </div>

    <!-- Filter RT -->
    <div class="input-group !mb-0">
      <select id="filter-kk-rt"
              class="modern-input !pl-10"
              onchange="resetKkPage(); filterKkList()">
        <option value="">Semua RT</option>
        <option value="1">RT 01</option>
        <option value="2">RT 02</option>
        <option value="3">RT 03</option>
        <option value="4">RT 04</option>
      </select>
      <span class="material-icons">filter_list</span>
    </div>
  </div>

  <div id="kk-list"></div>
  <div id="kk-pagination" class="pagination-controls"></div>
</section>


      <!-- Form -->
      <section id="page-add" class="page">
    <h2 id="form-title" class="text-xl font-black mb-6" style="color: var(--text-main)">Input Data Warga</h2>

        <div class="mb-6 p-4 rounded-[32px] border-2 border-dashed border-indigo-200 dark:border-slate-700 bg-indigo-50/50 dark:bg-slate-800/50 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <span class="material-icons">document_scanner</span>
            </div>
            <div>
                <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">Fitur Pintar</p>
                <h4 class="text-[11px] font-extrabold text-slate-700 dark:text-slate-200">Scan KTP Otomatis</h4>
            </div>
        </div>
        
        <input type="file" id="scan-ktp-input" accept="image/*" class="hidden" onchange="handleOcrKtp(event)">
        <label for="scan-ktp-input" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all active:scale-95 cursor-pointer">
            Ambil Foto
        </label>
    </div>
        
    <form id="form-warga" onsubmit="handleSaveWarga(event)" class="space-y-4 pb-24">
        <input type="hidden" id="f-original-nik">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="form-label" style="color: var(--text-muted)">NIK<span class="required-icon">*</span></label>
                <input type="number" id="f-nik" class="modern-input" required>
                <p id="error-nik" class="hidden text-[9px] text-red-500 font-bold mt-1 uppercase tracking-tight">
                    * NIK ini sudah digunakan oleh warga lain
                </p>
            </div>                 
            <div>
                <label class="form-label" style="color: var(--text-muted)">No KK</label>
                <input type="number" id="f-kk" class="modern-input">
            </div>
        </div>

        <div>
            <label class="form-label" style="color: var(--text-muted)">Nama Lengkap<span class="required-icon">*</span></label>
            <input type="text" id="f-nama" class="modern-input" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="form-label" style="color: var(--text-muted)">Kelamin<span class="required-icon">*</span></label>
                <select id="f-kelamin" class="modern-input" required> <option value="" disabled selected>Pilih Kelamin</option>
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                </select>
            </div>
            <div>
                <label class="form-label" style="color: var(--text-muted)">Agama<span class="required-icon">*</span></label>
                <select id="f-agama" class="modern-input" required> <option value="" disabled selected>Pilih Agama</option>
                    <option value="Islam">Islam</option><option value="Kristen">Kristen</option><option value="Katolik">Katolik</option><option value="Buddha">Buddha</option><option value="Hindu">Hindu</option><option value="Konghucu">Konghucu</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div><label class="form-label" style="color: var(--text-muted)">Tempat Lahir<span class="required-icon">*</span></label><input type="text" id="f-tempat" class="modern-input" required></div>
            <div><label class="form-label" style="color: var(--text-muted)">Tanggal Lahir<span class="required-icon">*</span></label><input type="date" id="f-tanggal" class="modern-input" required></div>
        </div>

      <div class="grid grid-cols-2 gap-4">
    <div>
        <label class="form-label" style="color: var(--text-muted)">Status Perkawinan<span class="required-icon">*</span></label>
        <select id="f-perkawinan" class="modern-input" required><option value="" disabled selected>Pilih Status Perkawinan</option>
            <option value="Belum kawin">Belum kawin</option>
            <option value="Kawin">Kawin</option>
            <option value="Cerai Hidup">Cerai Hidup</option>
            <option value="Cerai Mati">Cerai Mati</option>
        </select>
    </div>
    <div>
        <label class="form-label" style="color: var(--text-muted)">Status Tinggal<span class="required-icon">*</span></label>
        <select id="f-tinggal" class="modern-input"required><option value="" disabled selected>Pilih Status Tinggal</option>
            <option value="Tetap">Tetap</option>
            <option value="Kontrak">Kontrak</option>
            <option value="Kos">Kos</option>
            <option value="Lainnya">Lainnya</option>
        </select>
    </div>
</div>

<div>
    <label class="form-label" style="color: var(--text-muted)">Pekerjaan<span class="required-icon">*</span></label>
    <select id="f-pekerjaan" class="modern-input" required> <option value="" disabled selected>Pilih Pekerjaan</option>
        <option value="Belum/Tidak Bekerja">Belum/Tidak Bekerja</option>
        <option value="Mengurus Rumah Tangga">Mengurus Rumah Tangga</option>
        <option value="Pelajar/Mahasiswa">Pelajar/Mahasiswa</option>
        <option value="Pensiunan">Pensiunan</option>
        <option value="PNS">PNS</option>
        <option value="TNI">TNI</option>
        <option value="POLRI">POLRI</option>
        <option value="Karyawan Swasta">Karyawan Swasta</option>
        <option value="Wiraswasta">Wiraswasta</option>
        <option value="Petani">Petani</option>
        <option value="Nelayan">Nelayan</option>
    </select>
</div>
      
        <div class="p-4 rounded-2xl space-y-4 border transition-colors duration-300" 
     style="background-color: var(--input-bg); border-color: var(--border-color);">
    
    <p class="text-[10px] font-black uppercase tracking-widest" style="color: var(--pastel-primary)">
        Alamat Tinggal Sekarang
    </p>
    
    <div class="grid grid-cols-3 gap-2">
        <div>
            <label class="form-label" style="color: var(--text-muted)">Blok<span class="required-icon">*</span></label>
            <select id="f-blok" class="modern-input !pl-2" onchange="syncKtp()" required><option value="" disabled selected>Pilih Blok</option>
                <option value="A">A</option><option value="B">B</option><option value="B1">B1</option>
                <option value="C">C</option><option value="D">D</option><option value="E">E</option>
                <option value="F">F</option><option value="G">G</option><option value="Masjid">Masjid</option>
            </select>
        </div>
        <div>
            <label class="form-label" style="color: var(--text-muted)">No<span class="required-icon">*</span></label>
            <input type="text" id="f-nomer" class="modern-input !pl-2" oninput="syncKtp()" required>
        </div>
        <div>
            <label class="form-label" style="color: var(--text-muted)">RT<span class="required-icon">*</span></label>
            <select id="f-rt" class="modern-input !pl-2" onchange="syncKtp()" required> <option value="" disabled selected>Pilih RT</option>
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option>
            </select>
        </div>
    </div>
</div>

        <div>
            <div class="flex justify-between items-center mb-1">
                <label class="form-label !mb-0" style="color: var(--text-muted)">Alamat KTP<span class="required-icon">*</span></label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="sync-ktp-check" onchange="syncKtp()" class="w-3 h-3">
                    <span class="text-[9px] font-bold uppercase" style="color: var(--text-muted)">Sama dengan alamat tinggal</span>
                </label>
            </div>
            <textarea id="f-alamat-ktp" class="modern-input" placeholder="Tulis alamat lengkap sesuai KTP..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="form-label" style="color: var(--text-muted)">Status Keluarga<span class="required-icon">*</span></label>
                <select id="f-status-kel" class="modern-input" required><option value="" disabled selected>Pilih Status Keluarga</option>
                    <option value="Kepala Keluarga">Kepala Keluarga</option><option value="Istri">Istri</option><option value="Anak">Anak</option><option value="Orang Tua">Orang Tua</option><option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div><label class="form-label" style="color: var(--text-muted)">No HP / WA<span class="required-icon">*</span></label><input type="number" id="f-hp" class="modern-input"></div>
        </div>

        <div class="space-y-2">
            <label class="text-[10px] font-black uppercase tracking-widest px-1" style="color: var(--text-muted)">Foto Warga</label>
            <div class="relative">
                <input type="file" id="f-foto" accept="image/*" class="hidden" onchange="previewFoto()">
                <label for="f-foto" class="flex flex-col items-center justify-center w-full min-h-[120px] p-4 border-2 border-dashed rounded-3xl transition-all cursor-pointer group" 
                       style="background-color: var(--input-bg); border-color: var(--border-color);">
                    
                    <div id="container-preview" class="hidden mb-3 relative">
                        <img id="preview-foto" src="" class="w-24 h-24 object-cover rounded-2xl shadow-md border-2 border-white">
                    </div>

                    <div id="placeholder-upload" class="flex flex-col items-center">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm mb-2 group-hover:scale-110 transition-transform" style="background-color: var(--card-bg)">
                            <span class="material-icons" style="color: var(--soft-indigo)">add_a_photo</span>
                        </div>
                        <p class="text-[11px] font-bold uppercase tracking-tighter" style="color: var(--text-main)">Ambil Foto atau Upload</p>
                        <p class="text-[9px]" style="color: var(--text-muted)">PNG, JPG up to 5MB</p>
                    </div>
                </label>
            </div>
        </div>

        <button type="submit" class="btn-submit">Simpan Data Warga</button>
    </form>
</section>
    </main>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item active"><span class="material-symbols-rounded">dashboard</span><span>Beranda</span></button>
        <button onclick="navigate('warga')" id="nav-warga" class="nav-item"><span class="material-symbols-rounded">group_search</span><span>Warga</span></button>
        <button onclick="openFormTambah()" class="btn-add-center"><span class="material-icons">add</span></button>  
        <button onclick="navigate('kk')" id="nav-kk" class="nav-item"><span class="material-symbols-rounded">diversity_1</span><span>Keluarga</span></button>

      <button onclick="navigate('stats')" id="nav-stats" class="nav-item relative">
    <span class="material-symbols-rounded">demography</span>
    <span>Statistik</span>
    <span id="badge-hbd" class="hidden absolute -top-1 right-2 bg-pink-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">
        0
    </span>
</button>
    </nav>
    
  </div>
</div> <!-- div tutup main-app -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyQnIfaRQhv6r9jL_bJ3-uX9RhyUSAnUF4kt_lTCpgkHjWtXsCk4OWTBLPxB3JDz6L0qw/exec";
    let allData = [];
    let genderChart, rtChart;
    let wargaPage = 1, kkPage = 1;
    const PAGE_SIZE = 20;
    let currentStatTab = 'balita';
    let currentPage = "dashboard"; // halaman default


    // Handle back button on mobile
    window.addEventListener('popstate', function (event) {
        if (event.state && event.state.modal) {
            // Keep open
        } else if (document.getElementById('detail-modal').style.display === 'flex') {
            closeDetailSilent();
        }
    });

    function toggleLoading(s) { document.getElementById('loading-overlay-lama').style.display = s ? 'flex' : 'none'; }

    // permalink
window.addEventListener('hashchange', () => {
    const hash = window.location.hash;

    if (hash.startsWith('#detail-kk/')) {
        const noKk = hash.split('/')[1];
        if (noKk) showFamily(noKk);
    } 
    else if (hash.startsWith('#detail/')) {
        const nik = hash.split('/')[1];
        if (nik) showDetail(nik);
    } 
    else {
        // Jika hash adalah menu biasa (#dashboard, #warga, dll)
        const page = hash.replace('#', '') || 'dashboard';
        
        // Tutup modal jika masih terbuka saat navigasi berubah
        document.getElementById('detail-modal').style.display = 'none';
        
        navigate(page);
    }
});
    
   function navigate(p) {
    currentPage = p;
    window.location.hash = p; 
    closeDetailSilent();
    
    // 1. Mengaktifkan halaman yang dipilih
    document.querySelectorAll('.page').forEach(e => 
        e.classList.toggle('active', e.id === 'page-' + p)
    );
    
    // 2. Mengaktifkan menu di bottom-nav (Garis & Warna Aktif)
    document.querySelectorAll('.nav-item').forEach(e => {
        // Kita cek apakah ID elemen ini cocok dengan p (misal: nav-home, nav-stats, dll)
        const isActive = e.id === 'nav-' + p;
        e.classList.toggle('active', isActive);
    });

    window.scrollTo(0, 0);
    
    if (p === 'stats') {
        switchStatTab(currentStatTab);
    }
}

    function syncKtp() {
        const isChecked = document.getElementById('sync-ktp-check').checked;
        const target = document.getElementById('f-alamat-ktp');
        if(isChecked) {
            target.value = `Blok ${document.getElementById('f-blok').value} No ${document.getElementById('f-nomer').value} RT 0${document.getElementById('f-rt').value}`;
            target.readOnly = true; target.classList.add('opacity-60');
        } else {
            target.readOnly = false; target.classList.remove('opacity-60');
        }
    }

    async function handleLogin(e) {
      e.preventDefault(); toggleLoading(true);
      const u = document.getElementById('login-user').value;
      const p = document.getElementById('login-pass').value;
      try {
        const res = await fetch(`${API_URL}?action=checkLogin&args=${JSON.stringify([u, p])}`);
        const result = await res.json();
        if(result.success) {
           <!-- document.getElementById('welcome-text').innerText = `Halo ${u}! 👋`; -->
            localStorage.setItem('ewarga_user', u);
            updateUserInfoDisplay();
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            refreshData();
        } else { alert("Login Gagal"); }
      } catch (err) { alert("Error"); } finally { toggleLoading(false); }
    }

function logout() {
    if (confirm("Apakah Anda yakin ingin keluar?")) {
        localStorage.removeItem('ewarga_user');
        
        // Sembunyikan aplikasi segera
        document.getElementById('main-app').style.setProperty('display', 'none', 'important');
        document.getElementById('auth-container').style.setProperty('display', 'flex', 'important');
        
        // Opsional: bersihkan sisa data di memori
        allData = []; 
        
        location.reload(); // Segarkan halaman untuk membersihkan state
    }
}

async function refreshData() {
    toggleLoading(true);
    try {
        const res = await fetch(`${API_URL}?action=getAllWarga`);
        const rawData = await res.json();

        // AMBIL DATA USER DENGAN AMAN
        const rawUser = localStorage.getItem('ewarga_user');
        let userData = null;
        if (rawUser) {
            try { userData = JSON.parse(rawUser); } 
            catch (e) { userData = { role: rawUser, rt: "" }; }
        }

        // LOGIKA FILTER
        if (userData && userData.role === 'petugas') {
            allData = rawData.filter(w => String(w.RT) === String(userData.rt));
        } else if (userData && userData.role?.startsWith('rt')) { 
            // Tambahan jika role ditulis langsung "rt1", "rt2"
            const nomorRt = userData.role.replace('rt', '');
            allData = rawData.filter(w => String(w.RT) === nomorRt);
        } else {
            allData = rawData;
        }

        updateUI();
        updateBirthdayBadge();
        updateAgeStatistics(allData);
        if (currentPage === "dashboard") checkTodayBirthdayPopUp();
        switchStatTab(currentStatTab);
        updateTinggalChart();
        applyPermissions(); 

    } catch (e) {
        console.error("Error di refreshData:", e);
    } finally {
        toggleLoading(false);
    }
}

function applyPermissions() {
    const rawUser = localStorage.getItem('ewarga_user');
    let userData = null;

    if (rawUser) {
        try {
            // Coba baca sebagai JSON
            userData = JSON.parse(rawUser);
        } catch (e) {
            // Jika error (isinya cuma teks "admin"), buat objek manual
            userData = { role: rawUser, rt: "" };
        }
    }

    if (!userData) return;

    const btnTambah = document.querySelector('.btn-add-center');
    const btnEdit = document.getElementById('btn-edit-trigger');

    // Cek role (mendukung teks "lihat", "rw6", atau objek)
    const userRole = userData.role || userData; 

    if (userRole === 'lihat' || userRole === 'rw6') {
        if (btnTambah) btnTambah.style.display = 'none';
        if (btnEdit) btnEdit.style.display = 'none';
    } else {
        if (btnTambah) btnTambah.style.display = 'flex';
    }
}

    function updateUI() {
        document.getElementById('stat-total').innerText = allData.length;
        document.getElementById('stat-kk').innerText = allData.filter(w => w['Status Keluarga'] === 'Kepala Keluarga').length;
        renderCharts();
        renderList(allData.slice(-5).reverse(), 'latest-list'); 
        filterWargaList(); filterKkList();
    }

    // --- Statistik Page Logic ---
let statPage = 1;
const STAT_PAGE_SIZE = 10;
let filteredStatData = [];

// Fungsi utama untuk pindah tab
function changeStatPage(tab) {
    statPage = 1; // Reset ke halaman 1 setiap ganti tab
    switchStatTab(tab);
}

// Fungsi navigasi pagination
function navigateStatPage(direction) {
    statPage += direction;
    renderStatList();
}

function switchStatTab(tab) {
    if (!allData || allData.length === 0) return;
    currentStatTab = tab;
    
    // Update State Tab Active
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+tab));

    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const nextWeek = new Date(todayStart.getTime() + 7 * 24 * 60 * 60 * 1000);

    // Variabel penampung sementara untuk hitung badge
    let counts = { balita: 0, anak: 0, remaja: 0, dewasa: 0, lansia: 0, ultah: 0 };
    let tempFiltered = [];

    allData.forEach(w => {
        if (!w['Tanggal Lahir']) return;
        let tglStr = w['Tanggal Lahir'];
        
        // Handle format DD-MM-YYYY ke YYYY-MM-DD
        if (tglStr.includes('-') && tglStr.split('-')[0].length === 2) {
            const p = tglStr.split('-');
            tglStr = `${p[2]}-${p[1]}-${p[0]}`;
        }
        
        const bDate = new Date(tglStr);
        if (isNaN(bDate)) return;

        let age = today.getFullYear() - bDate.getFullYear();
        const m = today.getMonth() - bDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < bDate.getDate())) age--;

        // LOGIKA KLASIFIKASI (Untuk Hitung Semua Badge)
        let cat = "";
        if (age < 5) { cat = 'balita'; counts.balita++; }
        else if (age <= 11) { cat = 'anak'; counts.anak++; }
        else if (age <= 18) { cat = 'remaja'; counts.remaja++; }
        else if (age <= 59) { cat = 'dewasa'; counts.dewasa++; }
        else { cat = 'lansia'; counts.lansia++; }

        // Cek Ulang Tahun
        const bThisYear = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
        const isUltah = (bThisYear >= todayStart && bThisYear <= nextWeek);
        if (isUltah) counts.ultah++;

        // Masukkan ke filtered jika sesuai tab aktif
        if (tab === cat) {
            w._displayAge = age + " Thn";
            w._sortPriority = age;
            tempFiltered.push(w);
        } else if (tab === 'ultah' && isUltah) {
            const isToday = bDate.getMonth() === today.getMonth() && bDate.getDate() === today.getDate();
            const ageTarget = today.getFullYear() - bDate.getFullYear();
            if (isToday) {
                w._displayAge = `HARI INI 🎂 ke-${ageTarget}th`;
                w._sortPriority = 0;
            } else {
                w._displayAge = `${bDate.getDate()} ${bDate.toLocaleDateString('id-ID', { month: 'short' })} (ke-${ageTarget}th)`;
                w._sortPriority = bThisYear.getTime();
            }
            tempFiltered.push(w);
        }
    });

    // Update SEMUA Badge di UI
    Object.keys(counts).forEach(k => {
        const badge = document.getElementById(`badge-${k}`);
        if (badge) badge.innerText = counts[k];
    });

    // Sorting
    if (tab === 'ultah') {
        tempFiltered.sort((a, b) => a._sortPriority - b._sortPriority);
    } else {
        tempFiltered.sort((a, b) => b._sortPriority - a._sortPriority);
    }

    filteredStatData = tempFiltered;
    renderStatList();
  // Memastikan tombol yang aktif bergeser ke tengah kontainer
const activeTab = document.getElementById('tab-' + tab);
if (activeTab) {
    activeTab.scrollIntoView({
        behavior: 'smooth',
        inline: 'center',
        block: 'nearest'
    });
}
}

function renderStatList() {
    const listContainer = document.getElementById('stat-list-container');
    const totalItems = filteredStatData.length;

    if (totalItems === 0) {
        listContainer.innerHTML = `<div class="p-10 text-center text-slate-300 font-bold text-xs uppercase tracking-widest">Tidak ada data</div>`;
        document.getElementById('stat-pagination').innerHTML = "";
        return;
    }

    // Pagination Logic
    const start = (statPage - 1) * STAT_PAGE_SIZE;
    const end = start + STAT_PAGE_SIZE;
    const paginatedItems = filteredStatData.slice(start, end);

    listContainer.innerHTML = paginatedItems.map(w => `
        <div class="warga-card animate__animated animate__fadeInUp" onclick="showDetail('${w.NIK}')" style="animation-duration: 0.3s">
            <div class="avatar ${w.Kelamin.startsWith('L') ? 'bg-indigo-400' : 'bg-pink-400'}">${w.Nama[0]}</div>
            <div class="flex-1">
                <h4 class="text-xs font-extrabold text-slate-800">${w.Nama}</h4>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Blok ${w.Blok} No ${w.Nomer} • RT 0${w.RT}</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black ${w._sortPriority === 0 && currentStatTab === 'ultah' ? 'text-pink-500' : 'text-indigo-500'}">${w._displayAge}</p>
            </div>
        </div>
    `).join('');

    // Panggil fungsi renderPagination bawaan Anda
    renderPagination(totalItems, statPage, 'stat-pagination', 'navigateStatPage');
}

function filterWargaList() {
    const query = document.getElementById('search-warga').value.toLowerCase().trim();
    const rtFilter = document.getElementById('filter-rt').value;
    
    // Pecah input menjadi array kata kunci
    const keywords = query.split(/\s+/);

    const filtered = allData.filter(w => {
        // 1. Logika Filter RT (Harus Cocok Lebih Dulu)
        const matchRT = rtFilter === "" || (w.RT && w.RT.toString() === rtFilter);
        if (!matchRT) return false;

        // 2. Logika Pencarian Multi-Kata
        return keywords.every(key => {
            const nama = (w.Nama || "").toLowerCase();
            const nik = (w.NIK || "").toString().toLowerCase();
            const blok = (w.Blok || "").toLowerCase();
            const nomer = (w.Nomer || w.NOMER || "").toString().toLowerCase();
            
            // LOGIKA AKURASI:
            // - Jika panjang kunci hanya 1-2 karakter, kemungkinan besar itu Blok atau No.
            // - Kita gunakan perbandingan sama persis (===) untuk Blok dan Nomor
            return nama.includes(key) || 
                   nik.includes(key) || 
                   blok === key ||      // Pencocokan Blok harus persis (G tidak akan kena AG)
                   nomer === key ||     // Pencocokan Nomor harus persis (16 tidak akan kena 116)
                   (blok + nomer) === key.replace(/\s/g, ''); // Menangani input "G16"
        });
    });

    // 3. Render dengan Pagination
    const start = (wargaPage - 1) * PAGE_SIZE;
    renderList(filtered.slice(start, start + PAGE_SIZE), 'all-warga-list');
    renderPagination(filtered.length, wargaPage, 'warga-pagination', 'changeWargaPage');
}

    function resetWargaPage() { wargaPage = 1; }
    function changeWargaPage(step) { wargaPage += step; filterWargaList(); window.scrollTo(0, 0); }

    function filterKkList() {
  const query = document.getElementById('search-kk').value.toLowerCase();
  const rtFilter = document.getElementById('filter-kk-rt').value;

  const filtered = allData
    // hanya Kepala Keluarga
    .filter(w => w['Status Keluarga'] === 'Kepala Keluarga')
    // search nama / no KK
    .filter(kk => {
      const matchSearch =
        (kk.Nama || '').toLowerCase().includes(query) ||
        (kk['No KK'] || kk['NO KK'] || '').toString().includes(query);

      const matchRT =
        rtFilter === '' ||
        (kk.RT && kk.RT.toString() === rtFilter);

      return matchSearch && matchRT;
    });

  const start = (kkPage - 1) * PAGE_SIZE;
  renderKkList(filtered.slice(start, start + PAGE_SIZE));
  renderPagination(filtered.length, kkPage, 'kk-pagination', 'changeKkPage');
}


    function resetKkPage() { kkPage = 1; }
    function changeKkPage(step) { kkPage += step; filterKkList(); window.scrollTo(0, 0); }

    function renderPagination(totalItems, currentPage, targetId, callbackName) {
        const totalPages = Math.ceil(totalItems / PAGE_SIZE);
        const container = document.getElementById(targetId);
        if (totalPages <= 1) { container.innerHTML = ""; return; }
        container.innerHTML = `
            <button class="btn-page" ${currentPage === 1 ? 'disabled' : ''} onclick="${callbackName}(-1)"><span class="material-icons" style="font-size:14px">chevron_left</span></button>
            <span class="text-[10px] font-black text-slate-400">Hal ${currentPage} / ${totalPages}</span>
            <button class="btn-page" ${currentPage === totalPages ? 'disabled' : ''} onclick="${callbackName}(1)"><span class="material-icons" style="font-size:14px">chevron_right</span></button>
        `;
    }

    function renderCharts() {
      const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#94a3b8' : '#64748b'; // Warna teks grid
      
        const priaCount = allData.filter(w => (w.Kelamin || "").toLowerCase().startsWith('l')).length;
        const wanitaCount = allData.filter(w => (w.Kelamin || "").toLowerCase().startsWith('p')).length;
        document.getElementById('label-pria').innerText = priaCount;
        document.getElementById('label-wanita').innerText = wanitaCount;
        if (genderChart) genderChart.destroy();
        genderChart = new Chart(document.getElementById('chartGender'), {
            type: 'doughnut',
            data: { datasets: [{ data: [priaCount, wanitaCount], backgroundColor: ['#818cf8', '#f472b6'], borderWidth: 0 }] },
            options: { cutout: '50%', plugins: { legend: { display: false } }, maintainAspectRatio: false }
        });

        const rtCounts = [0, 0, 0, 0];
        allData.forEach(w => { const rt = parseInt(w.RT); if (rt >= 1 && rt <= 4) rtCounts[rt-1]++; });
        if (rtChart) rtChart.destroy();
        rtChart = new Chart(document.getElementById('chartRT'), {
            type: 'bar',
            data: { labels: ['RT 01', 'RT 02', 'RT 03', 'RT 04'], datasets: [{ data: rtCounts, backgroundColor: ['#A5B4FC', '#FDA4AF', '#FCD34D', '#6EE7B7'], borderRadius: 12 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
        });
      // Tambahkan opsi warna pada scales:
        options: {
            scales: {
                y: { 
                    ticks: { color: textColor } // Sesuaikan warna angka di grafik
                }
                x: { 
                    ticks: { color: textColor } 
                }
            }
        }
    }

function renderList(data, target) {
    const container = document.getElementById(target);
    if (data.length === 0) { 
        container.innerHTML = `<div class="p-8 text-center text-slate-300 font-bold text-xs">Kosong</div>`; 
        return; 
    }
    
    container.innerHTML = data.map(w => {
        // Ambil data blok dan nomer, pastikan tidak muncul 'undefined' jika kosong
        const blok = w.Blok || w.BLOK || "";
        const nomer = w.Nomer || w.NOMER || "";
        const alamatSingkat = (blok || nomer) ? `${blok}${nomer} ` : "";

        return `
            <div class="warga-card" onclick="showDetail('${w.NIK}')">
                <div class="avatar ${(w.Kelamin || '').toLowerCase().startsWith('l') ? 'bg-indigo-400' : 'bg-pink-400'}">
                    ${(w.Nama || 'W')[0]}
                </div>
                <div class="flex-1">
                    <h4 class="text-xs font-extrabold text-slate-800">${w.Nama}</h4>
                    <p class="text-[9px] font-bold text-slate-400 uppercase">NIK: ${w.NIK}</p>
                </div>
              <span class="text-[8px] font-black px-2 py-1 bg-slate-100 rounded-lg text-slate-500">
              <span class="text-indigo-500">${alamatSingkat}</span>RT ${w.RT || '-'}
              </span>
            </div>
        `;
    }).join('');
}


    // Ambil inisial nama (maks 2 huruf)
function getInitials(name) {
  if (!name) return "?";
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1) return parts[0][0].toUpperCase();
  return (parts[0][0] + parts[1][0]).toUpperCase();
}

// Warna pastel konsisten berdasarkan teks (nama / no KK)
function pastelColorFromString(str) {
  const colors = [
    '#A5B4FC', // indigo pastel
    '#FBCFE8', // pink pastel
    '#BFDBFE', // blue pastel
    '#BBF7D0', // green pastel
    '#FDE68A', // yellow pastel
    '#FED7AA', // orange pastel
    '#E9D5FF', // purple pastel
    '#BAE6FD'  // sky pastel
  ];

  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}
  
  function countFamilyMembers(noKk) {
  return allData.filter(w =>
    (w['No KK'] || w['NO KK'] || '').toString() === noKk.toString()
  ).length;
}

    
  function renderKkList(data) {
  const container = document.getElementById('kk-list');
  if (data.length === 0) {
    container.innerHTML = `<div class="p-8 text-center text-slate-300 font-bold text-xs">Kosong</div>`;
    return;
  }

  container.innerHTML = data.map(kk => {
    const nama = kk.Nama || '';
    const noKk = kk['No KK'] || kk['NO KK'];
    const inisial = getInitials(nama);
    const warna = pastelColorFromString(nama);
    const jumlah = countFamilyMembers(noKk);

    return `
      <div class="warga-card relative" onclick="showFamily('${noKk}')">
        
        <!-- Avatar Inisial -->
        <div class="avatar" style="background:${warna}; color:#1e293b;">
          <span class="text-xs font-black">${inisial}</span>
        </div>

        <!-- Info KK -->
        <div class="flex-1">
          <h4 class="text-xs font-extrabold text-slate-800">${nama}</h4>
          <p class="text-[9px] font-bold text-slate-400">KK: ${noKk}</p>
        </div>

        <!-- Badge Jumlah Anggota -->
        <div class="px-2 py-1 rounded-full text-[9px] font-black
                    bg-indigo-100 text-indigo-600">
          ${jumlah} org
        </div>

        <span class="material-icons text-slate-300 ml-1">chevron_right</span>
      </div>
    `;
  }).join('');
}



function showDetail(nik) {
  const w = allData.find(x => x.NIK.toString() === nik.toString());
  if (!w) return;

  // --- PERBAIKAN LOGIKA AMBIL USER (SAFE PARSE) ---
  const rawUser = localStorage.getItem('ewarga_user');
  let userData = null;

  if (rawUser) {
    try {
      // Jika isinya JSON {"role":"admin"}, ini akan berhasil
      userData = JSON.parse(rawUser);
    } catch (e) {
      // Jika isinya cuma teks "admin", kita buat jadi objek manual
      userData = { role: rawUser, rt: "" };
    }
  }

  const btnEdit = document.getElementById('btn-edit-trigger');

  // Logika Role: Sembunyikan jika role adalah 'lihat' atau 'rw6'
  const userRole = userData ? userData.role : '';
  if (userRole === 'lihat' || userRole === 'rw6') {
    btnEdit.style.display = 'none';
  } else {
    btnEdit.style.display = 'flex';
    btnEdit.onclick = () => openFormEdit(w);
  }
  // -----------------------------------------------

  const slug = w.Nama.toLowerCase().replace(/ /g, '-');
  window.location.hash = `detail/${w.NIK}/${slug}`;
  history.pushState({ modal: true }, null, "");

  const rawHp = (w['No HP'] || w['NO HP'] || "").toString();
  let waLink = "";
  if (rawHp) {
    let cleanHp = rawHp.replace(/\D/g, '');
    if (cleanHp.startsWith('0')) cleanHp = '62' + cleanHp.substring(1);
    if (cleanHp.startsWith('8')) cleanHp = '62' + cleanHp;
    waLink = `https://wa.me/${cleanHp}`;
  }

  const fotoUrl = (w.Foto && w.Foto !== '')
    ? w.Foto
    : "https://raw.githubusercontent.com/puriagung2/warga/refs/heads/main/default-foto.png";

  const genderClass =
    (w.Kelamin || '').toLowerCase().startsWith('l') ? "ring-blue-400" :
    (w.Kelamin || '').toLowerCase().startsWith('p') ? "ring-pink-400" :
    "ring-slate-300";

  document.getElementById('detail-content').innerHTML = `
        <div class="p-5 rounded-3xl shadow-lg border transition-colors duration-300" style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex flex-col items-center">
                <div class="relative">
                    <img 
                        src="${fotoUrl}"
                        onclick="openPhotoViewer('${fotoUrl}')"
                        class="w-28 h-28 object-cover rounded-2xl border shadow ring-4 ${genderClass} cursor-pointer transition-transform duration-200 hover:scale-105"
                    >
                    <div class="absolute -bottom-2 right-1 bg-indigo-500 text-white text-[10px] px-2 py-0.5 rounded-md shadow">
                        ${w['Status Keluarga'] || 'Warga'}
                    </div>
                </div>
                <h2 class="text-[17px] font-black mt-3 text-center" style="color: var(--text-main);">${w.Nama}</h2>
                <p class="text-[11px] tracking-wide" style="color: var(--text-muted);">${w.NIK}</p>
            </div>
            <div class="my-3 border-t" style="border-color: var(--border-color);"></div>
            <div class="space-y-[6px]"> 
                ${renderDetailItem('NO KK', w['No KK'] || w['NO KK'])}
                ${renderDetailItem('Agama', w.Agama)}
                ${renderDetailItem('Jenis Kelamin', w.Kelamin)}
                ${renderDetailItem('Tempat Lahir', w['Tempat Lahir'])}
                ${renderDetailItem('Tanggal Lahir', w['Tanggal Lahir'])}
                ${renderDetailItem('Status Kawin', w['Status Perkawinan'])}
                ${renderDetailItem('Status Tinggal', w['Status Tinggal'])}
                ${renderDetailItem('Pekerjaan', w.Pekerjaan)}
                ${renderDetailItem('No HP', rawHp ? `<a href="${waLink}" target="_blank" class="text-green-600 font-semibold flex items-center gap-1"><span>${rawHp}</span><span class="material-icons text-[14px]">open_in_new</span></a>` : '-')}
                ${renderDetailItem('Alamat Tinggal', w['Alamat Tinggal'] || `Blok ${w.Blok} No ${w.Nomer} RT 0${w.RT}`)}
                ${renderDetailItem('Alamat KTP', w['Alamat KTP'])}
                ${renderDetailItem('Terakhir Update', w['Tanggal Update'] || '-')}
                ${renderDetailItem('Oleh', w['Updated By'] || '-')}
            </div>
        </div>
    `;

  document.getElementById('detail-modal').style.display = 'flex';
}

function renderDetailItem(label, value) {
    return `
        <div class="flex justify-between items-start gap-4">
            <span class="text-[10px] font-bold uppercase tracking-tight" style="color: var(--text-muted);">${label}</span>
            <span class="text-[11px] font-semibold text-right" style="color: var(--text-main);">${value || '-'}</span>
        </div>
    `;
}


function showFamily(noKk) {
    const members = allData.filter(w => (w['No KK'] || w['NO KK'] || "").toString() === noKk.toString());
    
    // 1. Tentukan Prioritas Status
    const priority = {
        "KEPALA KELUARGA": 1,
        "ISTRI": 2,
        "ANAK": 3
    };

    // 2. Logika Sorting Multi-Level
    members.sort((a, b) => {
        const statusA = (a['Status Keluarga'] || "").toUpperCase();
        const statusB = (b['Status Keluarga'] || "").toUpperCase();
        
        const weightA = priority[statusA] || 99;
        const weightB = priority[statusB] || 99;

        // Jika statusnya berbeda (misal KK vs Istri), urutkan berdasarkan status
        if (weightA !== weightB) {
            return weightA - weightB;
        }

        // Jika statusnya SAMA (misal sama-sama ANAK), urutkan berdasarkan umur
        // Kita bandingkan Tanggal Lahir (Kolom: 'Tanggal Lahir' atau 'TANGGAL LAHIR')
        const tglA = new Date(a['Tanggal Lahir'] || a['TANGGAL LAHIR'] || "1900-01-01");
        const tglB = new Date(b['Tanggal Lahir'] || b['TANGGAL LAHIR'] || "1900-01-01");

        // Tanggal yang lebih kecil (lebih tua) muncul lebih dulu
        return tglA - tglB;
    });

    // --- Sisa kode untuk menampilkan UI (sama seperti sebelumnya) ---
    window.location.hash = `detail-kk/${noKk}`;
    history.pushState({modal: true}, null, "");
    document.getElementById('btn-edit-trigger').style.display = 'none';
    
    let html = `<h3 class="text-xs font-black text-slate-800 mb-4 px-2 uppercase tracking-widest">Keluarga No KK: ${noKk}</h3>`;
    
    members.forEach(m => {
        html += `
            <div class="warga-card" onclick="showDetail('${m.NIK}')">
                <div class="avatar ${(m.Kelamin || '').toLowerCase().startsWith('l') ? 'bg-indigo-400' : 'bg-pink-400'}">
                    ${(m.Nama || 'W')[0]}
                </div>
                <div class="flex-1">
                    <h4 class="text-xs font-extrabold text-slate-800 dark:text-slate-100">${m.Nama}</h4>
                    <p class="text-[9px] font-bold text-slate-400 uppercase">
                        ${m['Status Keluarga']} ${m['Status Keluarga'].toUpperCase() === 'ANAK' ? '• ' + calculateAge(m['Tanggal Lahir']) + ' Thn' : ''}
                    </p>
                </div>
            </div>`;
    });
    
    document.getElementById('detail-content').innerHTML = html;
    document.getElementById('detail-modal').style.display = 'flex';
}


// Fungsi tambahan untuk menghitung umur (agar tampilan lebih informatif)
function calculateAge(birthDate) {
    if (!birthDate) return "";
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
}

    function handleBackAction() { if (history.state && history.state.modal) { history.back(); } else { closeDetail(); } }

    function closeDetail() { 
        document.getElementById('detail-modal').style.display = 'none'; 
        document.getElementById('btn-edit-trigger').style.display = 'block'; 
      // Kembalikan hash ke halaman aktif (misal #warga atau #dashboard)
    window.location.hash = currentPage;
    }

    function closeDetailSilent() {
        document.getElementById('detail-modal').style.display = 'none'; 
        document.getElementById('btn-edit-trigger').style.display = 'block'; 
    }
    
    function openFormEdit(w) {
        closeDetailSilent();
        document.getElementById('f-original-nik').value = w.NIK;
        document.getElementById('f-nik').value = w.NIK;
        document.getElementById('f-kk').value = w['No KK'] || w['NO KK'];
        document.getElementById('f-nama').value = w.Nama;
        document.getElementById('f-kelamin').value = w.Kelamin;
        document.getElementById('f-agama').value = w.Agama || "Islam";
        document.getElementById('f-tempat').value = w['Tempat Lahir'] || "";
        document.getElementById('f-tanggal').value = w['Tanggal Lahir'] || "";
        document.getElementById('f-perkawinan').value = w['Status Perkawinan'] || "Belum kawin";
        document.getElementById('f-tinggal').value = w['Status Tinggal'] || "Tetap";
        document.getElementById('f-blok').value = w.Blok;
        document.getElementById('f-nomer').value = w.Nomer;
        document.getElementById('f-rt').value = w.RT;
        document.getElementById('f-alamat-ktp').value = w['Alamat KTP'] || "";
        document.getElementById('f-status-kel').value = w['Status Keluarga'] || "Kepala Keluarga";
        document.getElementById('f-hp').value = w['No HP'] || w['NO HP'] || "";
        document.getElementById('f-pekerjaan').value = w.Pekerjaan || "Belum/Tidak Bekerja";
        document.getElementById('sync-ktp-check').checked = false; syncKtp();
        navigate('add');
      // === FOTO EDIT ===
// === PERBAIKAN FOTO EDIT (Sesuai UI Modern) ===
    const fotoInput = document.getElementById("f-foto");
    const preview = document.getElementById("preview-foto");
    const container = document.getElementById("container-preview");
    const placeholder = document.getElementById("placeholder-upload");

    // 1. Reset input file agar tidak membawa file dari sesi sebelumnya
    fotoInput.value = "";

    // 2. Jika data warga memiliki foto
    if (w.Foto && w.Foto.trim() !== "") {
        // Tampilkan foto
        preview.src = w.Foto; 
        
        // Atur UI Modern: Tampilkan kotak preview, sembunyikan ikon upload
        container.classList.remove("hidden");
        placeholder.classList.add("hidden");
    } else {
        // Jika tidak ada foto
        preview.src = "";
        
        // Atur UI Modern: Sembunyikan kotak preview, tampilkan ikon upload
        container.classList.add("hidden");
        placeholder.classList.remove("hidden");
    }

    }

async function handleSaveWarga(e) {
    e.preventDefault();
 // --- 1. AMBIL NILAI NIK ---
    const nikInput = document.getElementById("f-nik").value;
    const originalNik = document.getElementById("f-original-nik").value;
    const elErrorNik = document.getElementById("error-nik"); // Ambil elemen pesan teks

    // --- 2. VALIDASI DUPLIKAT NIK ---
    const isDuplicate = allData.some(warga => 
        warga.NIK.toString() === nikInput.toString() && 
        nikInput.toString() !== originalNik.toString()
    );

    if (isDuplicate) {
        showToast("Gagal! NIK sudah terdaftar", "error");
        
        const elNik = document.getElementById("f-nik");
        elNik.focus();
        
        // --- TAMBAHKAN BARIS INI ---
        if (elErrorNik) elErrorNik.classList.remove('hidden'); // Menghilangkan class hidden agar teks muncul
        
        // Tambahkan kelas error dan animasi getar
        elNik.classList.add('border-red-500', 'bg-red-50', 'animate-shake');
        
        setTimeout(() => {
            elNik.classList.remove('animate-shake');
        }, 500);

        return; 
    } else {
        // Jika tidak duplikat, sembunyikan kembali teks dan hapus warna merah
        if (elErrorNik) elErrorNik.classList.add('hidden'); 
        document.getElementById("f-nik").classList.remove('border-red-500', 'bg-red-50');
    }
    toggleLoading(true);

    // const originalNik = document.getElementById("f-original-nik").value;

    // Ambil foto lama
    let existingFoto = "";
    if (originalNik) {
        const f = allData.find(x => x.NIK == originalNik);
        if (f) existingFoto = f.Foto || "";
    }

    // Proses foto baru
    let fotoBase64 = "";
    const fotoFile = document.getElementById("f-foto").files[0];
    if (fotoFile) {
        fotoBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(fotoFile);
        });
    }

    // Baca field form
    const fBlok  = document.getElementById("f-blok").value;
    const fNomer = document.getElementById("f-nomer").value;
    const fRT    = document.getElementById("f-rt").value;
    const alamatTinggal = `Blok ${fBlok} No ${fNomer} RT 0${fRT}`;

    // --- TAMBAHKAN INI SEBELUM PAYLOAD ---
    const rawUser = localStorage.getItem('ewarga_user');
    let currentUserData = { role: 'Guest', rt: '' };
    if (rawUser) {
        try {
            currentUserData = JSON.parse(rawUser);
        } catch (e) {
            currentUserData = { role: rawUser, rt: '' };
        }
    }
    
    const payload = {
        originalNik: originalNik,
        nik: document.getElementById("f-nik").value,
        kk: document.getElementById("f-kk").value,
        nama: document.getElementById("f-nama").value,
        kelamin: document.getElementById("f-kelamin").value,
        agama: document.getElementById("f-agama").value,
        tempat: document.getElementById("f-tempat").value,
        tanggal: document.getElementById("f-tanggal").value,
        perkawinan: document.getElementById("f-perkawinan").value,
        tinggal: document.getElementById("f-tinggal").value,
        blok: fBlok,
        nomer: fNomer,
        rt: fRT,
        currentUser: currentUserData, // Tambahkan ini agar divalidasi oleh code.gs
        alamatKTP: document.getElementById("f-alamat-ktp").value,
        alamatTinggal: alamatTinggal,
        statusKel: document.getElementById("f-status-kel").value,
        hp: document.getElementById("f-hp").value,
        pekerjaan: document.getElementById("f-pekerjaan").value,
        fotoData: fotoBase64 || "",   // jika kosong → pakai foto lama di server
        // --- TAMBAHKAN DUA BARIS INI KE PAYLOAD ---
        updatedBy: currentUserData.role + (currentUserData.rt ? ` RT${currentUserData.rt}` : ""),
        lastUpdate: new Date().toLocaleString('id-ID')
    };

    try {
        // Kirim ke server
        await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveWarga",
                args: [payload]
            })
        });

        // Refresh data global
        await refreshData();

        // Tutup modal edit
const addWrap = document.getElementById("add-wrapper");
if (addWrap) addWrap.style.display = "none";

// Buka halaman detail warga
showDetail(payload.nik);

        // Tampilkan halaman detail warga yang baru disimpan
        showDetail(payload.nik);


showToast("Data berhasil disimpan!");

    } catch (err) {
        console.error("SAVE ERROR:", err);
        alert("Gagal menyimpan data!");

    } finally {
        toggleLoading(false);
    }
}




  function checkLoginState() {
    const user = localStorage.getItem('ewarga_user');
    const authContainer = document.getElementById('auth-container');
    const mainApp = document.getElementById('main-app');

    if (user) {
        // Tampilkan Aplikasi, Sembunyikan Login
        if (authContainer) authContainer.style.display = 'none';
        
        // Paksa main-app muncul sebagai flex container
        if (mainApp) {
            mainApp.style.setProperty('display', 'flex', 'important');
        }
        
        updateUserInfoDisplay();
        refreshData();
    } else {
        // Tampilkan Login, Sembunyikan Aplikasi
        if (authContainer) authContainer.style.display = 'flex';
        if (mainApp) {
            mainApp.style.setProperty('display', 'none', 'important');
        }
    }
}
// Panggil fungsi ini tepat saat script dimuat
window.addEventListener('DOMContentLoaded', checkLoginState);
    
    function getUsers() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_USERS);
  const data = sh.getDataRange().getValues();
  const headers = data.shift();
  
  return data.map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}

    async function doLogin() {
    const user = document.getElementById('username-input').value; // Sesuaikan ID input Anda
    const pass = document.getElementById('password-input').value; // Sesuaikan ID input Anda
    
    showLoading(true);
    try {
        // Memanggil fungsi checkLogin di kode .gs dengan parameter action dan args
        const params = encodeURIComponent(JSON.stringify([user, pass]));
        const response = await fetch(`${scriptUrl}?action=checkLogin&args=${params}`);
        const result = await response.json();

try {
        const params = encodeURIComponent(JSON.stringify([user, pass]));
        const response = await fetch(`${scriptUrl}?action=checkLogin&args=${params}`);
        const result = await response.json();

        if (result.success) {
            // PENTING: result harus berupa OBJEK yang mengandung key 'nama'
            // Kita simpan SELURUH objek result ke localStorage
            localStorage.setItem('ewarga_user', JSON.stringify(result));
            
            // Console log untuk memastikan data yang masuk benar
            console.log("Data Login Berhasil:", result);

            // ... sisa kode pindah halaman ...
            location.reload(); // Refresh untuk memastikan semua variabel terisi
        } else {
            alert("Login Gagal");
        }
    } catch (err) {
        console.error(err);
    }
}

  // Jalankan saat halaman pertama kali dibuka
  document.addEventListener('DOMContentLoaded', checkLoginState);

    // reset form
    function resetForm() {
    // Reset form secara keseluruhan
    document.getElementById('form-warga').reset();
    // Pastikan hidden input original-nik juga dikosongkan
    document.getElementById('f-original-nik').value = "";
    // Jika Anda menggunakan checkbox "Sama dengan alamat tinggal", pastikan itu juga di-uncheck
    const syncCheck = document.getElementById('sync-ktp-check');
    if(syncCheck) syncCheck.checked = false;
    // Set judul form kembali ke default
    document.getElementById('form-title').innerText = "Input Data Warga";
}
    function openFormTambah() {
    // 1. Reset isi form agar kosong
    document.getElementById('form-warga').reset();
    
    // 2. Kosongkan field tersembunyi (Sangat Penting!)
    document.getElementById('f-original-nik').value = "";
    
    // 3. Ubah Judul Form menjadi Input Data (bukan Edit)
    document.getElementById('form-title').innerText = "Input Data Warga";

     // --- LOGIKA PENGUNCI RT YANG LEBIH AMAN ---
    const rawUser = localStorage.getItem('ewarga_user');
    const rtInput = document.getElementById("f-rt");

    if (rawUser && rtInput) {
        let userData;
        try {
            // Coba baca sebagai JSON
            userData = JSON.parse(rawUser);
        } catch (e) {
            // Jika error (seperti kasus Anda), buat objek darurat
            userData = { role: 'petugas', rt: rawUser.replace(/\D/g, "") }; 
        }

        if (userData && userData.role === 'petugas') {
            rtInput.value = userData.rt;
            rtInput.readOnly = true;
            rtInput.style.backgroundColor = "#f1f5f9";
            rtInput.style.cursor = "not-allowed";
        } else {
            rtInput.readOnly = false;
            rtInput.style.backgroundColor = "white";
            rtInput.style.cursor = "default";
        }
    }
    // --- AKHIR LOGIKA AMAN ---
    
    // 4. Pastikan checkbox alamat KTP tidak tercentang
    const checkKtp = document.getElementById('sync-ktp-check');
    if(checkKtp) checkKtp.checked = false;

      // === TAMBAHKAN INI: RESET VISUAL FOTO ===
    const preview = document.getElementById("preview-foto");
    const container = document.getElementById("container-preview");
    const placeholder = document.getElementById("placeholder-upload");
    const fotoInput = document.getElementById("f-foto");

    if (preview && container && placeholder) {
        fotoInput.value = ""; // Pastikan input file kosong
        preview.src = "";     // Hapus gambar yang tersisa
        container.classList.add("hidden");      // Sembunyikan kotak foto
        placeholder.classList.remove("hidden"); // Munculkan ikon "Add Photo" lagi
    }
      // Sembunyikan pesan error NIK jika sebelumnya sempat muncul
    const elErrorNik = document.getElementById("error-nik");
    if(elErrorNik) elErrorNik.classList.add('hidden');
    
    document.getElementById("f-nik").classList.remove('border-red-500', 'bg-red-50');
      
    // 5. Pindah ke halaman form
    navigate('add');
    
    // 6. Tutup detail jika sedang terbuka
    if (typeof closeDetail === "function") closeDetail();
}
    // ultah
    function updateBirthdayBadge() {
    const today = new Date();
    const tMonth = today.getMonth();
    const tDate = today.getDate();

    const countToday = allData.filter(w => {
        if (!w['Tanggal Lahir']) return false;
        const b = new Date(w['Tanggal Lahir']);
        return b.getMonth() === tMonth && b.getDate() === tDate;
    }).length;

    const badge = document.getElementById('badge-hbd');
    if (countToday > 0) {
        badge.innerText = countToday;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}
    // pop up ultah
    function checkTodayBirthdayPopUp() {
    const today = new Date();
    const tMonth = today.getMonth();
    const tDate = today.getDate();

    // Filter warga yang ultah hari ini
    const birthdayKids = allData.filter(w => {
        if (!w['Tanggal Lahir']) return false;
        const b = new Date(w['Tanggal Lahir']);
        return b.getMonth() === tMonth && b.getDate() === tDate;
    });

    if (birthdayKids.length > 0) {
    const listContainer = document.getElementById('list-ultah-today');
    listContainer.innerHTML = birthdayKids.map(w => {
        const age = today.getFullYear() - new Date(w['Tanggal Lahir']).getFullYear();
        return `
            <div class="flex items-center gap-4 p-3 rounded-2xl border transition-colors duration-300" 
                 style="background-color: var(--input-bg); border-color: var(--border-color);">
                
                <div class="w-10 h-10 rounded-xl bg-pink-400 flex items-center justify-center text-white font-black text-sm shadow-sm">
                    ${w.Nama[0]}
                </div>
                
                <div class="text-left">
                    <h4 class="text-xs font-black transition-colors duration-300" style="color: var(--text-main);">
                        ${w.Nama}
                    </h4>
                    <p class="text-[9px] font-bold text-pink-500 uppercase tracking-tight">
                        Ulang Tahun ke-${age}th • Warga RT 0${w.RT}
                    </p>
                </div>
            </div>
        `;
    }).join('');

    // Tampilkan Modal
    document.getElementById('modal-ultah').classList.remove('hidden');
}
}

function closeUltahModal() {
    document.getElementById('modal-ultah').classList.add('hidden');
}


    // preview foto
function previewFoto() {
    const fileInput = document.getElementById("f-foto");
    const img = document.getElementById("preview-foto");
    const container = document.getElementById("container-preview"); // Wadah foto
    const placeholder = document.getElementById("placeholder-upload"); // Ikon upload

    // Jika tidak ada file yang dipilih (batal)
    if (fileInput.files.length === 0) {
        img.src = "";
        container.classList.add("hidden");
        placeholder.classList.remove("hidden");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        img.src = e.target.result;
        
        // Tampilkan foto, sembunyikan icon/teks "Upload"
        container.classList.remove("hidden");
        placeholder.classList.add("hidden");
        
        // Opsional: Berikan feedback suara atau getar ringan jika di HP
        if (window.navigator.vibrate) window.navigator.vibrate(50);
    };
    
    reader.readAsDataURL(fileInput.files[0]);
}

// Tambahkan fungsi ini jika ingin ada tombol hapus manual
function resetFoto() {
    const fileInput = document.getElementById("f-foto");
    fileInput.value = ""; // Bersihkan input file
    previewFoto(); // Panggil fungsi preview untuk mereset UI
}
function addNewWarga() {
    document.getElementById("form-warga").reset();
    document.getElementById("f-original-nik").value = "";
    resetFotoForm();
    navigate("page-add");
}

// reset preview foto
  function openAddForm() {
    document.getElementById("form-warga").reset();
    document.getElementById("f-original-nik").value = "";
document.getElementById("f-foto").value = "";
    document.getElementById("preview-foto").src = "";
    document.getElementById("preview-foto").classList.add("hidden");

    document.getElementById("preview-foto").src = "img/default-foto.png"; 
    document.getElementById("foto-input").value = "";
    window.currentFoto = ""; 

    // RESET FOTO
    const pf = document.getElementById("preview-foto");
    const ff = document.getElementById("f-foto");

    ff.value = "";
    pf.src = "";
    pf.classList.add("hidden");

    navigate("page-add");
}

    // klik foto profil
function openPhotoViewer(url) {
    const modal = document.getElementById("photo-viewer");
    const img = document.getElementById("photo-viewer-img");
    img.src = url;
    modal.classList.remove("hidden");
}

function closePhotoViewer() {
    document.getElementById("photo-viewer").classList.add("hidden");
}
// popup alert
    function showToast(message = "Data berhasil disimpan!", duration = 3000) {
    const toast = document.getElementById('custom-toast');
    const toastMsg = document.getElementById('toast-message');
    
    // Set pesan
    toastMsg.innerText = message;
    
    // Munculkan (Pop In)
    toast.classList.remove('translate-y-[-100px]', 'opacity-0');
    toast.classList.add('translate-y-0', 'opacity-100');
    
    // Sembunyikan otomatis setelah durasi tertentu (Pop Out)
    setTimeout(() => {
        toast.classList.remove('translate-y-0', 'opacity-100');
        toast.classList.add('translate-y-[-100px]', 'opacity-0');
    }, duration);
}

    // duplikat NIK
    function isNikDuplicate(nik, originalNik = null) {
    // Jika sedang edit dan NIK tidak diubah, bukan duplikat
    if (originalNik && nik === originalNik) {
        return false;
    }
    
    // Cek apakah NIK sudah ada di database (allData)
    return allData.some(warga => warga.NIK.toString() === nik.toString());
}

    // darkmode
    function toggleDarkMode() {
        const body = document.body;
        const icon = document.getElementById('dark-icon');
        
        body.classList.toggle('dark');
        
        if (body.classList.contains('dark')) {
            icon.innerText = 'light_mode';
            localStorage.setItem('theme', 'dark');
        } else {
            icon.innerText = 'dark_mode';
            localStorage.setItem('theme', 'light');
        }
    }

    // Fungsi untuk memuat tema saat aplikasi dibuka
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        const icon = document.getElementById('dark-icon');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
            if(icon) icon.innerText = 'light_mode';
        }
    }

    // Panggil applySavedTheme di dalam DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        checkLoginState();
        applySavedTheme();
    });

  let dataUsers = []; // Data dari sheet 'users'
  let currentUser = JSON.parse(sessionStorage.getItem('session_user')) || null;

    async function fetchUsers() {
    try {
        const response = await fetch('URL_WEB_APP_SCRIPT_ANDA?sheet=users');
        dataUsers = await response.json();
    } catch (error) {
        console.error("Gagal mengambil data user:", error);
    }
}

   function updateUserInfoDisplay() {
    const rawUser = localStorage.getItem('ewarga_user');
    const banner = document.getElementById('user-info-banner');
    const textElement = document.getElementById('user-display-text');
    
    if (!rawUser) {
        banner.style.display = 'none';
        return;
    }

    let userData;
    try {
        userData = JSON.parse(rawUser);
    } catch (e) {
        // Handle jika data masih format teks lama
        userData = { role: rawUser, rt: "" };
    }

    banner.style.display = 'block';

    // Format Teks: ADMIN atau PETUGAS RT 01
    const roleName = userData.role.toUpperCase();
    const rtInfo = userData.rt ? `RT 0${userData.rt}` : "RW 06";
    
    textElement.innerHTML = `HALO: <span class="text-indigo-500">${roleName}</span> • ${rtInfo}`;
}

    function updateTinggalChart() {
    const ctx = document.getElementById('chartTinggal').getContext('2d');
    
    // 1. Hitung Frekuensi Data
    const stats = {};
    allData.forEach(w => {
        let status = w['Status Tinggal'] || w['TINGGAL'] || 'Lainnya';
        status = status.toUpperCase(); // Biar seragam
        stats[status] = (stats[status] || 0) + 1;
    });

    const labels = Object.keys(stats);
    const counts = Object.values(stats);
    
    // Warna untuk masing-masing status
    const colorMap = {
        'TETAP': '#6366f1',    // Indigo
        'KONTRAK': '#f59e0b',  // Amber
        'DOMISILI': '#10b981', // Emerald
        'KOSONG': '#94a3b8'    // Slate
    };
    const colors = labels.map(label => colorMap[label] || '#' + Math.floor(Math.random()*16777215).toString(16));

    // 2. Render Legend secara Dinamis
    const legendContainer = document.getElementById('tinggal-legend');
    legendContainer.innerHTML = ''; // Reset legend
    labels.forEach((label, index) => {
        legendContainer.innerHTML += `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full" style="background-color: ${colors[index]}"></div>
                    <span class="text-[9px] font-bold text-slate-500 uppercase">${label}</span>
                </div>
                <span class="text-xs font-black text-slate-800">${counts[index]}</span>
            </div>`;
    });

    // 3. Hancurkan chart lama jika ada (penting agar tidak error saat refresh)
    if (window.myTinggalChart) window.myTinggalChart.destroy();

    // 4. Buat Chart Baru
    window.myTinggalChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: counts,
                backgroundColor: colors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%', // Membuat ring lebih tipis dan elegan
            plugins: {
                legend: { display: false } // Legend kita buat sendiri secara manual di atas
            }
        }
    });
}


// 2. Definisi Fungsi exportToPDF (Harus sejajar dengan prosesExport)
function exportToPDF(data, judul) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); 
    
    // Header PDF
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text(judul, 14, 15); // Menggunakan judul dinamis

    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text(`Dicetak pada: ${new Date().toLocaleString()}`, 14, 22);

    const headers = [Object.keys(data[0])];
    const body = data.map(item => Object.values(item));

    doc.autoTable({
        head: headers,
        body: body,
        startY: 28,
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 2 },
        headStyles: { fillColor: [99, 102, 241], halign: 'center' },
        columnStyles: {
            0: { cellWidth: 8 },  // No
            1: { cellWidth: 35 }, // Nama
            2: { cellWidth: 30 }, // NIK
            4: { cellWidth: 35 }, // Tempat/Tgl Lahir
            6: { cellWidth: 45 }, // Alamat Tinggal
        }
    });

    // Nama file PDF dinamis
    const fileName = judul.replace(/\s+/g, '_') + ".pdf";
    doc.save(fileName);
    
    // Tutup sheet setelah export selesai
    if(typeof closeExportSheet === "function") closeExportSheet();
}

// Fungsi pembantu format tanggal untuk nama file
function formatTanggal(date) {
    return date.toISOString().split('T')[0];
}
// export pdf/xls
function prosesExport(format) {
    // 1. Ambil Nilai Filter
    const filterRT = document.getElementById('export-rt').value;
    const filterTinggal = document.getElementById('export-tinggal').value;
    const filterKategori = document.getElementById('export-kategori').value;

    // 2. Buat Judul Dinamis
    let judulDinamis = "DATA ";
    
    // Tambahkan Kategori ke Judul
    if (filterKategori === "ALL") judulDinamis += "WARGA ";
    else if (filterKategori === "KEPALA KELUARGA") judulDinamis += "KEPALA KELUARGA ";
    else judulDinamis += filterKategori + " ";

    // Tambahkan Status Tinggal ke Judul
    if (filterTinggal !== "ALL") judulDinamis += filterTinggal + " ";

    // Tambahkan RT ke Judul
    if (filterRT === "ALL") {
        judulDinamis += "RW 06";
    } else {
        judulDinamis += "RT " + filterRT + " RW 06";
    }

    // 3. Proses Filtering (Sama seperti sebelumnya)
    let filtered = allData.filter(w => {
        const matchRT = (filterRT === "ALL") || (String(w.RT || w.rt) === filterRT);
        const statusTinggalRaw = (w['Status Tinggal'] || w['TINGGAL'] || "").toUpperCase();
        const matchTinggal = (filterTinggal === "ALL") || (statusTinggalRaw === filterTinggal);
        
        const tglLahir = w['Tanggal Lahir'] || w['TANGGAL LAHIR'];
        const umur = tglLahir ? calculateAge(tglLahir) : 0;
        const statusKel = (w['Status Keluarga'] || "").toUpperCase();
        
        let matchKategori = true;
        if (filterKategori === "BALITA") matchKategori = (umur <= 5);
        if (filterKategori === "ANAK") matchKategori = (umur >= 5 && umur <= 11);        
        if (filterKategori === "REMAJA") matchKategori = (umur >= 12 && umur <= 18);
        else if (filterKategori === "LANSIA") matchKategori = (umur >= 60);
        else if (filterKategori === "KEPALA KELUARGA") matchKategori = (statusKel === "KEPALA KELUARGA");

        return matchRT && matchTinggal && matchKategori;
    });

    if (filtered.length === 0) {
        alert("Data tidak ditemukan!");
        return;
    }

const dataExport = filtered.map((w, index) => {
        // 1. Ambil data tempat dan tanggal
        const tempat = w['Tempat Lahir'] || w['TEMPAT LAHIR'] || "";
        const tglRaw = w['Tanggal Lahir'] || w['TANGGAL LAHIR'] || "";
        
        // 2. Format tanggal agar rapi (dd/mm/yyyy)
        let tglFormatted = "";
        if (tglRaw) {
            const d = new Date(tglRaw);
            // Cek apakah tanggal valid
            if (!isNaN(d.getTime())) {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                tglFormatted = `${day}/${month}/${year}`;
            } else {
                tglFormatted = tglRaw; // Gunakan teks asli jika bukan format Date
            }
        }

        // 3. Gabungkan Tempat dan Tanggal
        const tempatTglLahir = (tempat && tglFormatted) 
            ? `${tempat}, ${tglFormatted}` 
            : (tempat || tglFormatted);

        return {
            "No": index + 1,
            "Nama Lengkap": w.Nama,
            "NIK": `'${w.NIK}`,
            "No KK": `'${w['No KK'] || w['NO KK']}`,
            "Tempat/Tgl Lahir": tempatTglLahir, // Kolom Baru hasil penggabungan
            "Status Tinggal": w['Status Tinggal'] || w['TINGGAL'],
            "Alamat Tinggal": w['Alamat Tinggal'] || w['ALAMAT TINGGAL'] || "",
            "No HP": w.HP || w['NO HP'] || ""
        };
    });

    // 4. Eksekusi Export dengan Judul Baru
    if (format === 'xlsx') {
        const worksheet = XLSX.utils.json_to_sheet(dataExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
        // Nama file dinamis (spasi diganti underscore agar aman)
        const fileName = judulDinamis.replace(/\s+/g, '_') + ".xlsx";
        XLSX.writeFile(workbook, fileName);
    } else if (format === 'pdf') {
        // Kirim judulDinamis sebagai parameter tambahan
        exportToPDF(dataExport, judulDinamis); 
    }
}

// Fungsi pembantu format tanggal untuk nama file
function formatTanggal(date) {
    return date.toISOString().split('T')[0];
}

    function openExportSheet() {
    const sheet = document.getElementById('export-sheet');
    sheet.classList.remove('hidden');
    sheet.classList.add('flex');
}

function closeExportSheet() {
    const sheet = document.getElementById('export-sheet');
    sheet.classList.add('hidden');
    sheet.classList.remove('flex');
}

// Tambahkan pencegahan tutup jika area panel diklik (opsional)
// document.querySelector('#export-sheet > div:last-child').onclick = (e) => e.stopPropagation();

    // ocr scan ktp

    // 1. Fungsi Pre-process (Hitam Putih Tinggi Kontras)
function preprocessImage(imageElement) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Gunakan ukuran asli gambar
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    
    ctx.drawImage(imageElement, 0, 0);
    
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
        // Rumus Luminance yang lebih akurat untuk Grayscale
        const avg = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
        
        // Threshold: 120 (bisa disesuaikan, makin kecil makin banyak putih)
        const v = avg < 120 ? 0 : 255; 
        
        data[i] = data[i+1] = data[i+2] = v;
    }
    
    ctx.putImageData(imageData, 0, 0);
    return canvas.toDataURL('image/jpeg', 0.9);
}

// 2. Fungsi Utama Scan
async function handleOcrKtp(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Tampilkan Loading
    const overlay = document.getElementById('loading-overlay');
    const statusText = document.getElementById('status-text');
    overlay.style.display = 'flex';
    statusText.innerText = "MENGOMPRES GAMBAR...";

    try {
        const compressedFile = await compressImage(file);
        
        const formData = new FormData();
        formData.append("file", compressedFile);
        formData.append("apikey", "K83312111388957"); // API KEY ANDA
        formData.append("OCREngine", "3"); 
        formData.append("scale", "true");

        statusText.innerText = "MOHON TUNGGU...";

        let response = await fetch("https://api.ocr.space/parse/image", {
            method: "POST",
            body: formData
        });
        let result = await response.json();

        if (result && result.OCRExitCode === 1) {
            const rawText = result.ParsedResults[0].ParsedText;
            extractKtpData(rawText);

            // Sembunyikan loading
            overlay.style.display = 'none';

            // Tampilkan Alert Sukses yang Cantik
            Swal.fire({
                title: 'Scan Berhasil, Lakukan Verifikasi!',
                text: 'Data KTP telah otomatis masuk ke formulir.',
                icon: 'success',
                confirmButtonColor: '#3085d6',
                timer: 5000 // Otomatis tutup dalam 5 detik
            });

        } else {
            throw new Error(result.ErrorMessage || "Gagal memproses gambar");
        }

    } catch (err) {
        overlay.style.display = 'none';
        Swal.fire({
            title: 'Gagal Scan',
            text: err.message || 'Terjadi kesalahan koneksi. Ulangi lagi !',
            icon: 'error'
        });
    } finally {
        event.target.value = ""; 
    }
}

// Fungsi pembantu untuk kompresi gambar
function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1500; // Resolusi ideal untuk OCR Engine 3
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // Gambar ulang dengan kualitas tinggi tapi ukuran file lebih kecil
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                }, 'image/jpeg', 0.8); // Kualitas 80% (Sangat tajam tapi ringan)
            };
        };
    });
}

function extractKtpData(rawText) {
    const text = rawText.toUpperCase();
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);

    let alamatDetail = { jalan: "", rtRw: "", kel: "", kec: "", kota: "", prov: "" };

    lines.forEach((line, i) => {
        // --- 1. PROVINSI & KOTA ---
        if (line.includes("PROVINSI")) {
            alamatDetail.prov = line.replace("PROVINSI", "").trim();
            if (lines[i + 1] && !lines[i + 1].includes("NIK")) {
                alamatDetail.kota = lines[i + 1].trim();
            }
        }

        // --- 2. NIK ---
        if (line.includes("NIK")) {
            const nikMatch = line.replace(/\D/g, "").match(/\d{16}/);
            if (nikMatch) document.getElementById('f-nik').value = nikMatch[0];
        }

        // --- 3. NAMA ---
        if (line.includes("NAMA")) {
            let namaVal = line.replace(/.*NAMA\s*[:;i\s]*/i, "").trim();
            if (!namaVal) namaVal = lines[i+1] || "";
            document.getElementById('f-nama').value = namaVal.replace(/[^A-Z ]/g, "").trim();
        }

        // --- 4. TEMPAT & TANGGAL LAHIR ---
        if (line.includes("LAHIR")) {
            // Ambil teks setelah kata LAHIR, abaikan simbol apa pun
            let ttlVal = line.replace(/.*LAHIR\s*[:;i\s]*/i, "").trim();
            let parts = ttlVal.split(',');
            
            // Tempat
            if (parts.length > 0) {
                document.getElementById('f-tempat').value = parts[0].trim();
            }
            
            // Tanggal (Cari pola 00-00-0000)
            let dateMatch = ttlVal.match(/(\d{2})[\s-]*(\d{2})[\s-]*(\d{4})/);
            if (dateMatch) {
                document.getElementById('f-tanggal').value = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
            }
        }

        // --- 5. JENIS KELAMIN ---
        if (line.includes("KELAMIN") || line.includes("LAKI") || line.includes("PEREMPUAN")) {
            if (line.includes("LAKI")) document.getElementById('f-kelamin').value = "Laki-laki";
            else if (line.includes("PEREMPUAN")) document.getElementById('f-kelamin').value = "Perempuan";
        }

        // --- 6. AGAMA (Format Title Case untuk Select) ---
        const listAgama = ["Islam", "Kristen", "Katolik", "Buddha", "Hindu", "Konghucu"];
        listAgama.forEach(ag => {
            if (line.includes(ag.toUpperCase())) {
                document.getElementById('f-agama').value = ag;
            }
        });

        // --- 7. STATUS PERKAWINAN ---
        if (line.includes("KAWIN") || line.includes("STATUS")) {
            if (line.includes("BELUM")) document.getElementById('f-perkawinan').value = "Belum kawin";
            else if (line.includes("KAWIN")) document.getElementById('f-perkawinan').value = "Kawin";
            else if (line.includes("CERAI")) document.getElementById('f-perkawinan').value = "Cerai";
        }

        // --- 8. PEKERJAAN ---
        if (line.includes("KERJAAN") || line.includes("SWASTA") || line.includes("WIRASWASTA") || line.includes("PNS")) {
            let pekVal = line.replace(/.*PEKERJAAN\s*[:;i\s]*/i, "").trim();
            if (pekVal.includes("SWASTA")) document.getElementById('f-pekerjaan').value = "Karyawan Swasta";
            else if (pekVal.includes("WIRASWASTA")) document.getElementById('f-pekerjaan').value = "Wiraswasta";
            else document.getElementById('f-pekerjaan').value = pekVal; // Input manual jika beda
        }

        // --- 9. BAGIAN ALAMAT ---
        if (line.includes("ALAMAT")) alamatDetail.jalan = line.replace(/.*ALAMAT\s*[:;i\s]*/i, "").trim();
        if (line.includes("RT/RW")) {
            let rtrw = line.replace(/.*RT\/RW\s*[:;i\s]*/i, "").trim();
            let rtrwParts = rtrw.split('/');
            if (rtrwParts.length === 2) {
                alamatDetail.rtRw = `RT ${rtrwParts[0].trim()} RW ${rtrwParts[1].trim()}`;
            }
        }
        if (line.includes("KEL/DESA")) alamatDetail.kel = line.replace(/.*KEL\/DESA\s*[:;i\s]*/i, "").trim();
        if (line.includes("KECAMATAN")) alamatDetail.kec = line.replace(/.*KECAMATAN\s*[:;i\s]*/i, "").trim();
    });

    // Rangkai Alamat Lengkap
    const komponenAlamat = [alamatDetail.jalan, alamatDetail.rtRw, alamatDetail.kel, alamatDetail.kec, alamatDetail.kota, alamatDetail.prov]
        .filter(item => item && item.length > 1);
    document.getElementById('f-alamat-ktp').value = komponenAlamat.join(", ");
}

    // chart usia
let ageChart = null; // Inisialisasi variabel global

function updateAgeStatistics(data) {
    const wargaArray = Array.isArray(data) ? data : [];
    let counts = { balita: 0, anak: 0, remaja: 0, dewasa: 0, lansia: 0 };
    const today = new Date();

    wargaArray.forEach(w => {
        // MEMBACA KOLOM "Tanggal Lahir" (DENGAN SPASI)
        let tglRaw = w['Tanggal Lahir']; 
        if (!tglRaw) return;

        let tgl = String(tglRaw).trim();
        
        // Konversi format DD-MM-YYYY atau DD/MM/YYYY ke format yang dipahami JS (YYYY-MM-DD)
        tgl = tgl.replace(/\//g, '-');
        if (tgl.includes('-')) {
            const parts = tgl.split('-');
            if (parts[0].length === 2 && parts[2].length === 4) {
                tgl = `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
        }

        const birthDate = new Date(tgl);
        if (isNaN(birthDate.getTime())) return;

        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

        // KLASIFIKASI KEMENKES
        if (age < 5) counts.balita++;
        else if (age <= 11) counts.anak++;
        else if (age <= 18) counts.remaja++;
        else if (age <= 59) counts.dewasa++;
        else counts.lansia++;
    });
// log statistik usia di console
    console.log("Statistik Berhasil Dihitung:", counts);

    // Update Angka Label di UI
    const ids = ['balita', 'anak', 'remaja', 'dewasa', 'lansia'];
    ids.forEach(id => {
        const el = document.getElementById(`label-${id}`);
        if(el) el.innerText = counts[id];
    });

    // RENDER CHART
    const canvas = document.getElementById('chartAge');
    if (!canvas) return;

    if (window.ageChart) window.ageChart.destroy();

    window.ageChart = new Chart(canvas.getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Balita', 'Anak', 'Remaja', 'Dewasa', 'Lansia'],
            datasets: [{
                data: [counts.balita, counts.anak, counts.remaja, counts.dewasa, counts.lansia],
                backgroundColor: ['#22d3ee', '#a3e635', '#10b981', '#2563eb', '#f97316'],
                borderWidth: 1,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

// update profil
    // 1. Pastikan variabel ini ada di bagian paling atas script (global)
// agar bisa diakses oleh semua fungsi
// Fungsi untuk membuka Modal Profil
function openProfileModal() {
    const rawData = localStorage.getItem('ewarga_user');
    
    // Jika kosong sama sekali
    if (!rawData) {
        Swal.fire("Info", "Silakan login kembali", "info");
        return;
    }

    let userData;
    try {
        // Cek apakah rawData adalah string JSON yang valid
        if (rawData.trim().startsWith('{')) {
            userData = JSON.parse(rawData);
        } else {
            // JIKA DATA RUSAK (Hanya tulisan "admin"), kita buatkan objek darurat
            console.warn("Data bukan JSON, menggunakan fallback");
            userData = { 
                user: rawData, 
                nama: rawData, // Sementara nama diisi username agar tidak kosong
                role: 'lihat', 
                rt: '-' 
            };
        }
    } catch (e) {
        console.error("Gagal parse:", e);
        return;
    }

    // ISI KE HTML (Gunakan ID yang tepat)
    // 1. Header Nama
    document.getElementById('prof-display-name').innerText = userData.nama || userData.user || "User";
    
    // 2. Input Nama Lengkap (Kunci utama Anda)
    document.getElementById('prof-nama').value = userData.nama || "";
    
    // 3. Input Username (Readonly)
    document.getElementById('prof-username').value = userData.user || "";
    
    // 4. Input Password (Kosongkan)
    document.getElementById('prof-password').value = "";

    // 5. Update Badge Role
    const roleBadge = document.getElementById('prof-display-role');
    if (roleBadge) {
        const role = (userData.role || 'lihat').toUpperCase();
        const rt = userData.rt || '-';
        roleBadge.innerText = `${role} RT ${rt}`;
        
        let bgClass = "bg-slate-500";
        if (userData.role === "admin") bgClass = "bg-red-500";
        else if (userData.role === "petugas") bgClass = "bg-indigo-500";
        roleBadge.className = `inline-block px-3 py-1 rounded-full text-[10px] font-black text-white mt-2 ${bgClass}`;
    }

    // Tampilkan Modal
    const modal = document.getElementById('profile-modal');
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

// Fungsi untuk menutup Modal
function closeProfileModal() {
    const modal = document.getElementById('profile-modal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
}

function closeProfileModal() {
    const modal = document.getElementById('profile-modal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
}

// 2. Fungsi Logout yang sudah Anda miliki (Pastikan tetap ada)
function logout() {
    if (confirm("Apakah Anda yakin ingin keluar?")) {
        localStorage.removeItem('ewarga_user');
        document.getElementById('main-app').style.setProperty('display', 'none', 'important');
        document.getElementById('auth-container').style.setProperty('display', 'flex', 'important');
        allData = []; 
        location.reload(); 
    }
}

// 3. Fungsi Update Profile (Sesuai doPost JSON Anda)
async function updateProfile() {
    const btn = document.getElementById('btn-save-profile');
    const inputNama = document.getElementById('prof-nama').value;
    const inputUser = document.getElementById('prof-username').value;
    const inputPass = document.getElementById('prof-password').value;

    if (!inputNama) return Swal.fire("Error", "Nama harus diisi", "error");

    btn.disabled = true;
    btn.innerHTML = `<span class="animate-spin material-icons text-sm">sync</span> MENYIMPAN...`;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'updateUser',
                args: {
                    user: inputUser,
                    nama: inputNama,
                    password: inputPass
                }
            })
        });

        const result = await response.json();

        if (result.success) {
            // Update data di LocalStorage agar tidak perlu login ulang
            const localData = JSON.parse(localStorage.getItem('ewarga_user'));
            localData.nama = inputNama;
            localStorage.setItem('ewarga_user', JSON.stringify(localData));

            Swal.fire({ icon: 'success', title: 'Berhasil diperbarui', timer: 1500, showConfirmButton: false })
            .then(() => location.reload());
        }
    } catch (err) {
        Swal.fire("Error", "Gagal menyimpan perubahan", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<span class="material-icons text-sm">save</span> SIMPAN PERUBAHAN`;
    }
}
    
  </script>

  <div id="photo-viewer"
     class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-[9999]"
     onclick="closePhotoViewer()">
    <img id="photo-viewer-img"
         class="max-w-full max-h-full rounded-2xl shadow-xl border border-white/20">
</div>

  <div id="modal-ultah" class="fixed inset-0 z-[10000] hidden flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl transform transition-all animate-in zoom-in duration-300">
        <div class="bg-gradient-to-br from-pink-100 to-indigo-100 p-8 text-center relative">
            <div class="text-4xl mb-2">🎂</div>
            <h3 class="text-xl font-black text-slate-800">Selamat Ulang Tahun!</h3>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Warga yang Berbahagia Hari Ini</p>
            <button onclick="closeUltahModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <span class="material-icons">close</span>
            </button>
        </div>
        
        <div id="list-ultah-today" class="p-6 max-h-[300px] overflow-y-auto space-y-3">
            </div>

        <div class="p-6 pt-0 text-center">
            <button onclick="closeUltahModal()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-slate-200" style="background-color: #f5adbe;">
                Aamiin !
            </button>
        </div>
    </div>
</div>

<div id="custom-toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[10001] transform transition-all duration-300 translate-y-[-100px] opacity-0">
    <div class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-white/10">
        <div class="bg-green-500 rounded-full p-1 flex items-center justify-center">
            <span class="material-icons text-sm" style="font-size: 16px;">check</span>
        </div>
        <span id="toast-message" class="text-xs font-bold tracking-wide uppercase">Data berhasil disimpan!</span>
    </div>
</div>
</body>
</html>
